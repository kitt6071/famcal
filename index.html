<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kittson's Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --cream: #FEFCF8;
            --warm-white: #FDFBF7;
            --soft-beige: #F8F6F0;
            --nude-pink: #F4E6E0;
            --dusty-rose: #E8C5B5;
            --sage-green: #B8C5B1;
            --lavender-gray: #D4D1D7;
            --charcoal: #2C2C2C;
            --dark-gray: #4A4A4A;
            --medium-gray: #7A7A7A;
            --light-gray: #B5B5B5;
            
            --shadow-subtle: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-strong: 0 8px 24px rgba(0,0,0,0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--warm-white) 0%, var(--soft-beige) 100%);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: var(--charcoal);
            line-height: 1.6;
        }

        .display-font { 
            font-family: 'Playfair Display', serif;
            font-weight: 500;
            letter-spacing: -0.02em;
            color: var(--charcoal);
        }

        .content-font { 
            font-family: 'Inter', sans-serif; 
            font-weight: 400;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow-subtle);
        }
        
        .tab {
            background: var(--warm-white);
            border: 1px solid rgba(0,0,0,0.08);
            border-bottom: none;
            margin-bottom: -1px;
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s ease;
            border-radius: 12px 12px 0 0;
            position: relative;
        }

        .tab:hover {
            background: white;
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px);
        }

        .tab-active {
            background: white;
            border-color: var(--accent-soft, rgba(0,0,0,0.1));
            border-bottom-color: white !important;
            z-index: 10;
            box-shadow: var(--shadow-medium);
        }
        
        #main-content {
            background: white;
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 0 16px 16px 16px;
            box-shadow: var(--shadow-medium);
            position: relative;
            z-index: 1;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .day-cell {
            transition: all 0.2s ease;
            background: white;
            border: none;
            position: relative;
            min-height: 120px;
        }

        .day-cell:hover {
            background: var(--soft-beige);
            transform: none;
        }

        .day-cell.today {
            background: var(--nude-pink);
            position: relative;
        }

        .day-cell.today::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--dusty-rose);
            border-radius: 50%;
        }

        .event-bubble {
            transition: all 0.2s ease;
            border-radius: 6px;
            font-weight: 500;
            font-size: 11px;
            padding: 6px 8px;
            margin: 2px 0;
            border: none;
            color: var(--charcoal);
            background: var(--dusty-rose);
        }

        .event-bubble:hover {
            transform: none;
            opacity: 0.8;
        }

        .event-bubble-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .event-color-1 { background: var(--dusty-rose); }
        .event-color-2 { background: var(--sage-green); }
        .event-color-3 { background: var(--lavender-gray); }
        .event-color-4 { background: var(--nude-pink); }
        .event-color-5 { background: #E8D5C4; }
        .event-color-6 { background: #C8B5A6; }

        .daily-schedule {
            transition: transform 0.3s ease;
            transform: translateX(100%);
            background: white;
            border-left: 1px solid rgba(0,0,0,0.08);
        }

        .daily-schedule.open {
            transform: translateX(0);
        }

        .clean-btn {
            background: var(--charcoal);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .clean-btn:hover {
            background: var(--dark-gray);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .clean-btn.secondary {
            background: var(--light-gray);
            color: var(--charcoal);
        }

        .clean-btn.secondary:hover {
            background: var(--medium-gray);
            color: white;
        }

        .clean-input {
            background: white;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            width: 100%;
        }

        .clean-input:focus {
            outline: none;
            border-color: var(--dusty-rose);
            box-shadow: 0 0 0 3px rgba(232, 197, 181, 0.1);
        }

        .clean-input::placeholder {
            color: var(--medium-gray);
        }

        /* Clean Color Themes */
        .theme-warm-neutrals { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: var(--nude-pink); 
            --text-primary: var(--charcoal); 
            --accent: var(--dusty-rose); 
            --accent-soft: var(--nude-pink); 
        }
        .theme-sage-tones { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: var(--sage-green); 
            --text-primary: var(--charcoal); 
            --accent: var(--sage-green); 
            --accent-soft: #D4E5CE; 
        }
        .theme-lavender-mist { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: var(--lavender-gray); 
            --text-primary: var(--charcoal); 
            --accent: var(--lavender-gray); 
            --accent-soft: #E8E4EA; 
        }
        .theme-soft-beige { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: var(--soft-beige); 
            --text-primary: var(--charcoal); 
            --accent: #E8D5C4; 
            --accent-soft: var(--soft-beige); 
        }
        .theme-minimal-gray { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: #F5F5F5; 
            --text-primary: var(--charcoal); 
            --accent: var(--medium-gray); 
            --accent-soft: #F5F5F5; 
        }
        .theme-cream-rose { 
            --bg-primary: var(--cream); 
            --bg-secondary: #F9F0ED; 
            --text-primary: var(--charcoal); 
            --accent: #E8C5B5; 
            --accent-soft: #F4E6E0; 
        }
        
        .bg-primary { background: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .text-primary { color: var(--text-primary); }
        .accent { background-color: var(--accent); }
        .border-accent { border-color: var(--accent); }

        .weather-icon {
            transition: all 0.2s ease;
            filter: none;
        }

        .weather-icon:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-6 relative">
        <!-- Header -->
        <header class="flex items-center justify-between mb-8 bg-white rounded-lg p-6 shadow-md border border-gray-100">
            <h1 class="display-font text-4xl">Calendar</h1>
            <div id="weather-widget" class="text-right content-font">
                <div class="text-sm">
                    <p class="font-medium text-gray-700">Finding Location...</p>
                    <p class="text-gray-500">Loading weather...</p>
                </div>
            </div>
        </header>

        <!-- Calendar Tabs -->
        <div id="tabs-container" class="flex items-end -mb-px relative mb-4">
            <!-- Tabs will be dynamically inserted here -->
            <button id="add-calendar-btn" class="clean-btn ml-3 flex items-center gap-2">
                <i class="fas fa-plus text-sm"></i>
                <span>Add Calendar</span>
            </button>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="p-6 mb-6">
            <!-- Calendar Header -->
            <div class="flex justify-between items-center mb-6">
                <button id="prev-month" class="clean-btn secondary p-3">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="month-year" class="text-3xl font-medium display-font"></h2>
                <button id="next-month" class="clean-btn secondary p-3">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-0 text-center text-sm font-medium mb-4 text-gray-600">
                <div class="py-3">Sun</div>
                <div class="py-3">Mon</div>
                <div class="py-3">Tue</div>
                <div class="py-3">Wed</div>
                <div class="py-3">Thu</div>
                <div class="py-3">Fri</div>
                <div class="py-3">Sat</div>
            </div>
            <div id="calendar-grid" class="calendar-grid mb-8">
                <!-- Calendar days will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <!-- Daily Schedule Sidebar -->
    <div id="daily-schedule" class="daily-schedule fixed top-0 right-0 h-full w-full md:w-96 p-6 z-50 overflow-y-auto">
        <div class="flex justify-between items-center mb-6 bg-white rounded-lg p-4 shadow-sm border">
            <h3 class="text-xl font-medium content-font" id="schedule-date">Schedule</h3>
            <button id="close-schedule" class="clean-btn secondary p-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="schedule-content" class="space-y-2 mb-6">
            <!-- Hourly slots will be dynamically inserted here -->
        </div>
        <div class="bg-white rounded-lg p-6 shadow-sm border">
            <h4 class="font-medium mb-4 content-font">Add New Event</h4>
            <input type="text" id="schedule-event-input" class="clean-input mb-3" placeholder="Event name...">
            <input type="time" id="schedule-event-time" class="clean-input mb-4">
            <button id="schedule-add-event-btn" class="clean-btn w-full">
                Add Event
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <!-- Add Calendar Modal -->
    <div id="add-calendar-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-8 z-50 hidden w-96 border">
        <h3 class="text-2xl font-medium mb-6 content-font">Create New Calendar</h3>
        <input type="text" id="new-calendar-name" placeholder="Calendar Name (e.g., John's Calendar)" class="clean-input mb-6">
        <p class="font-medium mb-4 content-font">Choose a color scheme:</p>
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="color-scheme-option cursor-pointer transition-all duration-200 hover:scale-105" data-theme="theme-warm-neutrals">
                <div class="w-full h-12 rounded-lg flex items-center justify-center text-sm font-medium theme-warm-neutrals border">Warm Neutrals</div>
            </div>
            <div class="color-scheme-option cursor-pointer transition-all duration-200 hover:scale-105" data-theme="theme-sage-tones">
                <div class="w-full h-12 rounded-lg flex items-center justify-center text-sm font-medium theme-sage-tones border">Sage Tones</div>
            </div>
            <div class="color-scheme-option cursor-pointer transition-all duration-200 hover:scale-105" data-theme="theme-lavender-mist">
                <div class="w-full h-12 rounded-lg flex items-center justify-center text-sm font-medium theme-lavender-mist border">Lavender Mist</div>
            </div>
            <div class="color-scheme-option cursor-pointer transition-all duration-200 hover:scale-105" data-theme="theme-soft-beige">
                <div class="w-full h-12 rounded-lg flex items-center justify-center text-sm font-medium theme-soft-beige border">Soft Beige</div>
            </div>
            <div class="color-scheme-option cursor-pointer transition-all duration-200 hover:scale-105" data-theme="theme-minimal-gray">
                <div class="w-full h-12 rounded-lg flex items-center justify-center text-sm font-medium theme-minimal-gray border">Minimal Gray</div>
            </div>
            <div class="color-scheme-option cursor-pointer transition-all duration-200 hover:scale-105" data-theme="theme-cream-rose">
                <div class="w-full h-12 rounded-lg flex items-center justify-center text-sm font-medium theme-cream-rose border">Cream Rose</div>
            </div>
        </div>
        <div class="flex justify-end gap-3">
            <button id="cancel-add-calendar" class="clean-btn secondary">Cancel</button>
            <button id="confirm-add-calendar" class="clean-btn">Create</button>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-8 z-50 hidden w-96 border">
        <h3 class="text-2xl font-medium mb-6 content-font">Add Event for <span id="event-modal-date" class="font-normal text-gray-600"></span></h3>
        <input type="text" id="event-name-input" placeholder="Event Name" class="clean-input mb-6">
        <p class="font-medium mb-4 content-font">Event Color:</p>
        <div id="event-colors" class="flex gap-2 mb-6">
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-1" data-color="event-color-1"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-2" data-color="event-color-2"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-3" data-color="event-color-3"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-4" data-color="event-color-4"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-5" data-color="event-color-5"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-6" data-color="event-color-6"></div>
        </div>
        <p class="font-medium mb-4 content-font">Link with another calendar (optional):</p>
        <select id="link-calendar-select" class="clean-input mb-6">
            <option value="">None</option>
        </select>
        <div class="flex justify-end gap-3">
            <button id="cancel-add-event" class="clean-btn secondary">Cancel</button>
            <button id="save-event" class="clean-btn">Save Event</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let state = {
                currentDate: new Date(),
                calendars: [],
                activeCalendarId: null,
                weatherData: {}
            };

            // --- DOM ELEMENTS ---
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const tabsContainer = document.getElementById('tabs-container');
            const mainContent = document.getElementById('main-content');
            const appContainer = document.getElementById('app');
            
            // Modals
            const modalBackdrop = document.getElementById('modal-backdrop');
            const addCalendarModal = document.getElementById('add-calendar-modal');
            const addEventModal = document.getElementById('add-event-modal');

            // Daily Schedule
            const dailySchedulePanel = document.getElementById('daily-schedule');
            const scheduleDateHeader = document.getElementById('schedule-date');
            const scheduleContent = document.getElementById('schedule-content');
            
            // --- CONSTANTS & CONFIG ---
            // IMPORTANT: The weather feature requires a free API key from OpenWeatherMap.
            // 1. Go to https://openweathermap.org/appid
            // 2. Sign up and get your API key.
            // 3. Paste it here. This API provides weather data for locations worldwide.
            const WEATHER_API_KEY = '973209301a5a4be53a5337c204db93c2'; 
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const colorSchemes = {
                'theme-warm-neutrals': { 
                    bg: '#FDFBF7', 
                    secondary: '#F4E6E0', 
                    text: '#2C2C2C', 
                    accent: '#E8C5B5', 
                    'accent-soft': '#F4E6E0'
                },
                'theme-sage-tones': { 
                    bg: '#FDFBF7', 
                    secondary: '#B8C5B1', 
                    text: '#2C2C2C', 
                    accent: '#B8C5B1', 
                    'accent-soft': '#D4E5CE'
                },
                'theme-lavender-mist': { 
                    bg: '#FDFBF7', 
                    secondary: '#D4D1D7', 
                    text: '#2C2C2C', 
                    accent: '#D4D1D7', 
                    'accent-soft': '#E8E4EA'
                },
                'theme-soft-beige': { 
                    bg: '#FDFBF7', 
                    secondary: '#F8F6F0', 
                    text: '#2C2C2C', 
                    accent: '#E8D5C4', 
                    'accent-soft': '#F8F6F0'
                },
                'theme-minimal-gray': { 
                    bg: '#FDFBF7', 
                    secondary: '#F5F5F5', 
                    text: '#2C2C2C', 
                    accent: '#7A7A7A', 
                    'accent-soft': '#F5F5F5'
                },
                'theme-cream-rose': { 
                    bg: '#FEFCF8', 
                    secondary: '#F9F0ED', 
                    text: '#2C2C2C', 
                    accent: '#E8C5B5', 
                    'accent-soft': '#F4E6E0'
                }
            };


            // --- DATA PERSISTENCE ---
            function saveState() {
                localStorage.setItem('calendarAppState', JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem('calendarAppState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    // Convert date strings back to Date objects
                    parsedState.currentDate = new Date(parsedState.currentDate);
                    if(parsedState.calendars) {
                        parsedState.calendars.forEach(cal => {
                            if(cal.events) {
                                Object.values(cal.events).forEach(dayEvents => {
                                    dayEvents.forEach(event => event.date = new Date(event.date));
                                });
                            }
                        });
                    }
                    state = parsedState;
                } else {
                    // Initialize with a default calendar if none exists
                    const defaultId = `cal-${Date.now()}`;
                    state.calendars.push({
                        id: defaultId,
                        name: "Calendar",
                        theme: 'theme-warm-neutrals',
                        events: {}
                    });
                    state.activeCalendarId = defaultId;
                    
                    // Add some sample events to showcase the interface
                    const today = new Date();
                    const todayKey = `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
                    const tomorrowKey = `${today.getFullYear()}-${today.getMonth()}-${today.getDate() + 1}`;
                    
                    state.calendars[0].events[todayKey] = [
                        { id: 'sample1', name: 'Morning Coffee', color: 'event-color-1', completed: false, date: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 8, 0).toISOString() },
                        { id: 'sample2', name: 'Work Meeting', color: 'event-color-2', completed: true, date: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 10, 30).toISOString() }
                    ];
                    
                    state.calendars[0].events[tomorrowKey] = [
                        { id: 'sample3', name: 'Creative Project', color: 'event-color-3', completed: false, date: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 14, 0).toISOString() }
                    ];
                }
            }

            // --- WEATHER API ---
            async function getWeatherData(lat, lon, cityName) {
                document.querySelector('#weather-widget p:first-child').textContent = cityName;
                if (!WEATHER_API_KEY) {
                    console.warn("Weather API key is missing.");
                    document.querySelector('#weather-widget p:last-child').textContent = 'API Key needed';
                    return;
                }
                const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (!response.ok || !data.list || data.list.length === 0) {
                        console.error("Weather API error or empty response:", data);
                        let errorMessage = 'Weather data unavailable';
                        if (data && data.message) {
                             errorMessage = `Weather Error: ${data.message}`;
                        }
                        document.querySelector('#weather-widget p:last-child').textContent = errorMessage;
                        return;
                    }

                    document.querySelector('#weather-widget p:last-child').textContent = 
                        `${Math.round(data.list[0].main.temp)}Â°C, ${data.list[0].weather[0].main}`;

                    state.weatherData = {};
                    const dailyData = {};
                    data.list.forEach(item => {
                        const date = new Date(item.dt * 1000);
                        const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                        if (!dailyData[dateKey] || date.getHours() === 12) {
                             dailyData[dateKey] = {
                                temp: Math.round(item.main.temp),
                                icon: item.weather[0].icon
                            };
                        }
                    });
                    state.weatherData = dailyData;

                    renderCalendar();
                } catch (error) {
                    console.error("Error fetching weather data:", error);
                    document.querySelector('#weather-widget p:last-child').textContent = 'Weather unavailable';
                }
            }
            
            function getLocationAndFetchWeather() {
                 if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        let cityName = "Your Location";
                        if(WEATHER_API_KEY) {
                            try {
                                const geoUrl = `https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${WEATHER_API_KEY}`;
                                const geoResponse = await fetch(geoUrl);
                                const geoData = await geoResponse.json();
                                if(geoData[0]) cityName = geoData[0].name;
                            } catch (e) { console.error("Could not reverse geocode."); }
                        }
                        getWeatherData(lat, lon, cityName);
                    }, () => {
                        getWeatherData(51.5072, -0.1276, "London, UK");
                    });
                } else {
                    getWeatherData(51.5072, -0.1276, "London, UK");
                }
            }


            // --- CORE RENDER FUNCTIONS ---
            function renderCalendar() {
                const date = state.currentDate;
                const year = date.getFullYear();
                const month = date.getMonth();

                monthYearHeader.textContent = `${months[month]} ${year}`;
                calendarGrid.innerHTML = '';

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const activeCalendar = state.calendars.find(c => c.id === state.activeCalendarId);
                
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'p-2 border rounded-2xl bg-gray-50 opacity-50';
                    calendarGrid.appendChild(cell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('div');
                    const fullDate = new Date(year, month, day);
                    const dateKey = `${year}-${month}-${day}`;
                    
                    cell.className = 'day-cell p-4 flex flex-col cursor-pointer min-h-[140px] group';
                    cell.dataset.date = fullDate.toISOString();
                    
                    const today = new Date();
                    if (date.getFullYear() === today.getFullYear() && date.getMonth() === today.getMonth() && day === today.getDate()) {
                        cell.style.border = '3px solid var(--accent)';
                        cell.style.boxShadow = '0 0 20px rgba(var(--accent), 0.3)';
                        cell.classList.add('animate-bounce-in');
                    }
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'flex justify-between items-start mb-2';

                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'font-bold text-xl content-font text-gray-700';
                    dayNumber.textContent = day;
                    dayHeader.appendChild(dayNumber);
                    
                    if(state.weatherData[dateKey]) {
                        const weatherContainer = document.createElement('div');
                        weatherContainer.className = 'flex flex-col items-center text-xs text-gray-600';
                        const weatherIcon = document.createElement('img');
                        weatherIcon.src = `https://openweathermap.org/img/wn/${state.weatherData[dateKey].icon}.png`;
                        weatherIcon.className = 'w-8 h-8 weather-icon';
                        weatherContainer.appendChild(weatherIcon);
                        const tempSpan = document.createElement('span');
                        tempSpan.textContent = `${state.weatherData[dateKey].temp}Â°C`;
                        tempSpan.className = 'font-semibold';
                        weatherContainer.appendChild(tempSpan);
                        dayHeader.appendChild(weatherContainer);
                    }
                    cell.appendChild(dayHeader);

                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'flex-1 space-y-2 overflow-y-auto text-xs';
                    
                    if (activeCalendar && activeCalendar.events && activeCalendar.events[dateKey]) {
                        cell.style.background = `linear-gradient(135deg, ${colorSchemes[activeCalendar.theme].secondary}, rgba(255,255,255,0.9))`;
                        activeCalendar.events[dateKey].forEach(event => {
                            const eventEl = document.createElement('div');
                            eventEl.className = `event-bubble p-2 text-center text-white flex items-center justify-between text-xs font-semibold`;
                            eventEl.style.background = event.color || 'linear-gradient(135deg, #60a5fa, #3b82f6)';
                            if(event.completed) eventEl.classList.add('event-bubble-completed');
                            
                            const eventText = document.createElement('span');
                            eventText.textContent = event.name;
                            eventEl.appendChild(eventText);

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = event.completed;
                            checkbox.className = 'ml-2 w-4 h-4 rounded-full';
                            checkbox.onchange = (e) => {
                                e.stopPropagation();
                                toggleEventCompletion(event.id);
                            };
                            eventEl.appendChild(checkbox);
                            eventsContainer.appendChild(eventEl);
                        });
                    }
                    cell.appendChild(eventsContainer);

                    const addBtn = document.createElement('button');
                    addBtn.innerHTML = '<i class="fas fa-plus-circle text-2xl"></i>';
                    addBtn.className = 'self-center mt-auto opacity-0 group-hover:opacity-100 transition-all duration-300 text-purple-400 hover:text-purple-600 hover:scale-110';
                    addBtn.onclick = (e) => {
                        e.stopPropagation();
                        openAddEventModal(fullDate);
                    };
                    cell.appendChild(addBtn);
                    
                    cell.onclick = () => openDailySchedule(fullDate);

                    calendarGrid.appendChild(cell);
                }
            }

            function renderTabs() {
                const addBtn = document.getElementById('add-calendar-btn');
                tabsContainer.innerHTML = '';
                
                state.calendars.forEach(calendar => {
                    const tab = document.createElement('button');
                    tab.className = `tab px-8 py-4 rounded-t-2xl font-bold text-lg transition-all duration-500 relative content-font`;
                    
                    // Add emoji and styling based on theme
                    const themeEmojis = {
                        'theme-cotton-candy': 'ðŸ­',
                        'theme-sunny-day': 'â˜€ï¸',
                        'theme-minty-fresh': 'ðŸŒ¿',
                        'theme-blueberry-muffin': 'ðŸ«',
                        'theme-lavender-dreams': 'ðŸ’œ',
                        'theme-sunset-orange': 'ðŸ§¡'
                    };
                    
                    tab.innerHTML = `${themeEmojis[calendar.theme] || 'ðŸ“…'} ${calendar.name}`;
                    tab.dataset.calendarId = calendar.id;
                    
                    const theme = colorSchemes[calendar.theme];
                    if (calendar.id === state.activeCalendarId) {
                        tab.classList.add('tab-active');
                        tab.style.background = theme.bg;
                        tab.style.color = theme.text;
                        tab.style.borderColor = theme['accent-soft'];
                        
                        // Set CSS variables on the root for global access
                        const root = document.documentElement;
                        root.style.setProperty('--bg-primary', theme.bg);
                        root.style.setProperty('--bg-secondary', theme.secondary);
                        root.style.setProperty('--text-primary', theme.text);
                        root.style.setProperty('--accent', theme.accent);
                        root.style.setProperty('--accent-soft', theme['accent-soft']);
                        root.style.setProperty('--shadow-color', theme['shadow-color']);

                    } else {
                        tab.style.background = 'rgba(255, 255, 255, 0.8)';
                        tab.style.color = '#6b7280';
                    }

                    tab.onclick = () => switchCalendar(calendar.id);
                    tabsContainer.appendChild(tab);
                });
                
                tabsContainer.appendChild(addBtn);
                addBtn.addEventListener('click', openAddCalendarModal);
            }

            function renderDailySchedule(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();
                const dateKey = `${year}-${month}-${day}`;
                
                scheduleDateHeader.textContent = `ðŸ“… ${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`;
                scheduleContent.innerHTML = '';

                const activeCalendar = state.calendars.find(c => c.id === state.activeCalendarId);
                const events = (activeCalendar && activeCalendar.events[dateKey]) ? [...activeCalendar.events[dateKey]] : [];
                events.sort((a,b) => new Date(a.date) - new Date(b.date));

                for (let hour = 0; hour < 24; hour++) {
                    const hourEl = document.createElement('div');
                    hourEl.className = 'flex mb-3';
                    
                    const timeEl = document.createElement('div');
                    timeEl.className = 'w-20 text-sm text-purple-600 pr-3 text-right font-bold content-font glass-effect rounded-l-2xl p-2 flex items-center justify-center';
                    const timeIcon = hour < 6 ? 'ðŸŒ™' : hour < 12 ? 'ðŸŒ…' : hour < 18 ? 'â˜€ï¸' : 'ðŸŒ†';
                    timeEl.innerHTML = `${timeIcon}<br>${hour % 12 === 0 ? 12 : hour % 12} ${hour < 12 ? 'AM' : 'PM'}`;
                    
                    const slotEl = document.createElement('div');
                    slotEl.className = 'flex-1 glass-effect rounded-r-2xl p-3 min-h-[60px] flex flex-col justify-center';
                    
                    const eventsThisHour = events.filter(e => new Date(e.date).getHours() === hour);

                    if (eventsThisHour.length === 0) {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'text-gray-400 text-sm content-font text-center';
                        emptySlot.textContent = 'âœ¨ Free time';
                        slotEl.appendChild(emptySlot);
                    } else {
                        eventsThisHour.forEach(event => {
                            const eventDiv = document.createElement('div');
                            eventDiv.innerHTML = `<strong>${new Date(event.date).getMinutes().toString().padStart(2, '0')}:</strong> ${event.name}`;
                            eventDiv.className = `text-sm p-3 rounded-2xl text-white font-semibold mb-2 last:mb-0 shadow-md`;
                            eventDiv.style.background = event.color || 'linear-gradient(135deg, #60a5fa, #3b82f6)';
                            if (event.completed) {
                                eventDiv.style.textDecoration = 'line-through';
                                eventDiv.style.opacity = '0.7';
                            }
                            slotEl.appendChild(eventDiv);
                        });
                    }

                    hourEl.appendChild(timeEl);
                    hourEl.appendChild(slotEl);
                    scheduleContent.appendChild(hourEl);
                }
            }


            // --- EVENT HANDLERS & LOGIC ---
            function changeMonth(offset) {
                state.currentDate.setMonth(state.currentDate.getMonth() + offset);
                renderCalendar();
                saveState();
            }

            function switchCalendar(calendarId) {
                state.activeCalendarId = calendarId;
                renderTabs();
                renderCalendar();
                saveState();
            }
            
            function addCalendar(name, theme) {
                const newCalendar = {
                    id: `cal-${Date.now()}`,
                    name: name,
                    theme: theme,
                    events: {}
                };
                state.calendars.push(newCalendar);
                switchCalendar(newCalendar.id); // Use switchCalendar to set active and render
            }

            function addEvent(calendarId, date, name, color, linkedCalendarId) {
                const calendar = state.calendars.find(c => c.id === calendarId);
                if (!calendar) return;

                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();
                const dateKey = `${year}-${month}-${day}`;

                if (!calendar.events[dateKey]) {
                    calendar.events[dateKey] = [];
                }

                const newEvent = {
                    id: `evt-${Date.now()}`,
                    name: name,
                    color: color,
                    completed: false,
                    date: date.toISOString()
                };
                calendar.events[dateKey].push(newEvent);
                
                if (linkedCalendarId) {
                    const linkedCalendar = state.calendars.find(c => c.id === linkedCalendarId);
                    if (linkedCalendar) {
                        if (!linkedCalendar.events[dateKey]) {
                            linkedCalendar.events[dateKey] = [];
                        }
                        linkedCalendar.events[dateKey].push({...newEvent, id: `evt-${Date.now()}-linked`});
                    }
                }

                renderCalendar();
                if (dailySchedulePanel.classList.contains('open')) {
                    renderDailySchedule(new Date(date.getFullYear(), date.getMonth(), date.getDate()));
                }
                saveState();
            }
            
            function toggleEventCompletion(eventId) {
                const activeCalendar = state.calendars.find(c => c.id === state.activeCalendarId);
                if (activeCalendar && activeCalendar.events) {
                    for (const dateKey in activeCalendar.events) {
                        const event = activeCalendar.events[dateKey].find(e => e.id === eventId);
                        if (event) {
                            event.completed = !event.completed;
                            break;
                        }
                    }
                }
                renderCalendar();
                saveState();
            }


            // --- MODAL & SIDEBAR CONTROLS ---
            let selectedDateForEvent = null;
            let selectedColorScheme = 'theme-cotton-candy';
            let selectedEventColor = 'bg-red-400';

            function openModal(modal) {
                modalBackdrop.classList.remove('hidden');
                modal.classList.remove('hidden');
            }

            function closeModal(modal) {
                modalBackdrop.classList.add('hidden');
                modal.classList.add('hidden');
            }

            function openAddCalendarModal() {
                openModal(addCalendarModal);
            }

            function openAddEventModal(date) {
                selectedDateForEvent = date;
                document.getElementById('event-modal-date').textContent = date.toLocaleDateString();
                
                const select = document.getElementById('link-calendar-select');
                select.innerHTML = '<option value="">None</option>';
                state.calendars
                    .filter(c => c.id !== state.activeCalendarId)
                    .forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        select.appendChild(option);
                    });

                openModal(addEventModal);
            }

            function openDailySchedule(date) {
                renderDailySchedule(date);
                dailySchedulePanel.classList.add('open');
                modalBackdrop.classList.remove('hidden');
                dailySchedulePanel.dataset.date = date.toISOString();
            }

            function closeDailySchedule() {
                dailySchedulePanel.classList.remove('open');
                modalBackdrop.classList.add('hidden');
            }

            // Event Listeners for Modals & Sidebar
            document.getElementById('add-calendar-btn').addEventListener('click', openAddCalendarModal);
            document.getElementById('cancel-add-calendar').addEventListener('click', () => closeModal(addCalendarModal));
            document.getElementById('cancel-add-event').addEventListener('click', () => closeModal(addEventModal));
            modalBackdrop.addEventListener('click', () => {
                closeModal(addCalendarModal);
                closeModal(addEventModal);
                closeDailySchedule();
            });
            document.getElementById('close-schedule').addEventListener('click', closeDailySchedule);

            document.querySelectorAll('.color-scheme-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.color-scheme-option div').forEach(div => div.classList.remove('ring-4', 'ring-offset-2', 'ring-blue-500'));
                    el.querySelector('div').classList.add('ring-4', 'ring-offset-2', 'ring-blue-500');
                    selectedColorScheme = el.dataset.theme;
                });
            });

            document.getElementById('confirm-add-calendar').addEventListener('click', () => {
                const name = document.getElementById('new-calendar-name').value;
                if (name && selectedColorScheme) {
                    addCalendar(name, selectedColorScheme);
                    closeModal(addCalendarModal);
                    document.getElementById('new-calendar-name').value = '';
                }
            });

            document.getElementById('event-colors').addEventListener('click', (e) => {
                if (e.target.dataset.color) {
                    selectedEventColor = e.target.dataset.color;
                    document.querySelectorAll('#event-colors div').forEach(div => div.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
                    e.target.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                }
            });

            document.getElementById('save-event').addEventListener('click', () => {
                const name = document.getElementById('event-name-input').value;
                const linkedCalendarId = document.getElementById('link-calendar-select').value;
                if (name && selectedDateForEvent) {
                    const eventDate = new Date(selectedDateForEvent);
                    eventDate.setHours(12, 0, 0, 0);
                    addEvent(state.activeCalendarId, eventDate, name, selectedEventColor, linkedCalendarId);
                    closeModal(addEventModal);
                    document.getElementById('event-name-input').value = '';
                }
            });
            
            document.getElementById('schedule-add-event-btn').addEventListener('click', () => {
                const name = document.getElementById('schedule-event-input').value;
                const time = document.getElementById('schedule-event-time').value;
                const baseDate = new Date(dailySchedulePanel.dataset.date);
                
                if (name && time) {
                    const [hours, minutes] = time.split(':');
                    baseDate.setHours(parseInt(hours), parseInt(minutes));
                    addEvent(state.activeCalendarId, baseDate, name, 'bg-blue-400', null);
                    renderDailySchedule(new Date(dailySchedulePanel.dataset.date));
                    document.getElementById('schedule-event-input').value = '';
                    document.getElementById('schedule-event-time').value = '';
                }
            });


            // --- INITIALIZATION ---
            function init() {
                prevMonthBtn.addEventListener('click', () => changeMonth(-1));
                nextMonthBtn.addEventListener('click', () => changeMonth(1));

                loadState();
                getLocationAndFetchWeather();
                renderTabs();
                renderCalendar();
            }

            init();
        });
    </script>
</body>
</html>
