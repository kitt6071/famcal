<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kittson's Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700&family=Dancing+Script:wght@400;500;600;700&family=Raleway:wght@300;400;500;600;700&family=Crimson+Text:wght@400;600&family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --cream: #FEFCF8;
            --warm-white: #FDFBF7;
            --soft-beige: #F8F6F0;
            --nude-pink: #F4E6E0;
            --dusty-rose: #E8C5B5;
            --sage-green: #B8C5B1;
            --lavender-gray: #D4D1D7;
            --charcoal: #2C2C2C;
            --dark-gray: #4A4A4A;
            --medium-gray: #7A7A7A;
            --light-gray: #B5B5B5;
            
            --shadow-subtle: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-strong: 0 8px 24px rgba(0,0,0,0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--warm-white) 0%, var(--soft-beige) 100%);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: var(--charcoal);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }

        /* Decorative Background Elements */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.1;
            background-size: 300px 300px;
            background-repeat: repeat;
            transition: all 0.8s ease;
        }

        /* Theme-specific decorative backgrounds */
        body.theme-sage-tones::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Cdefs%3E%3Cstyle%3E.vine%7Bfill:none;stroke:%23B8C5B1;stroke-width:2;opacity:0.6%7D.leaf%7Bfill:%23B8C5B1;opacity:0.4%7D%3C/style%3E%3C/defs%3E%3Cpath class='vine' d='M50 50Q150 100 250 50M50 150Q150 200 250 150M50 250Q150 300 250 250'/%3E%3Cellipse class='leaf' cx='100' cy='75' rx='8' ry='15' transform='rotate(30 100 75)'/%3E%3Cellipse class='leaf' cx='200' cy='125' rx='8' ry='15' transform='rotate(-45 200 125)'/%3E%3Cellipse class='leaf' cx='150' cy='225' rx='8' ry='15' transform='rotate(60 150 225)'/%3E%3C/svg%3E");
            opacity: 0.15;
        }

        /* Theme-specific typography and styling */
        .theme-warm-neutrals {
            font-family: 'Poppins', sans-serif !important;
        }
        .theme-warm-neutrals .display-font {
            font-family: 'Dancing Script', cursive !important;
            font-weight: 600 !important;
        }
        .theme-warm-neutrals .content-font {
            font-family: 'Poppins', sans-serif !important;
        }
        
        .theme-sage-tones {
            font-family: 'Lora', serif !important;
        }
        .theme-sage-tones .display-font {
            font-family: 'Playfair Display', serif !important;
            font-weight: 600 !important;
        }
        .theme-sage-tones .content-font {
            font-family: 'Lora', serif !important;
        }
        
        .theme-matcha-dreams {
            font-family: 'Montserrat', sans-serif !important;
        }
        .theme-matcha-dreams .display-font {
            font-family: 'Raleway', sans-serif !important;
            font-weight: 500 !important;
            letter-spacing: 2px !important;
        }
        .theme-matcha-dreams .content-font {
            font-family: 'Montserrat', sans-serif !important;
        }
        
        .theme-lavender-mist {
            font-family: 'Inter', sans-serif !important;
        }
        .theme-lavender-mist .display-font {
            font-family: 'Crimson Text', serif !important;
            font-weight: 600 !important;
        }
        .theme-lavender-mist .content-font {
            font-family: 'Inter', sans-serif !important;
        }
        
        .theme-soft-beige {
            font-family: 'Raleway', sans-serif !important;
        }
        .theme-soft-beige .display-font {
            font-family: 'Playfair Display', serif !important;
            font-weight: 700 !important;
        }
        .theme-soft-beige .content-font {
            font-family: 'Raleway', sans-serif !important;
        }
        
        .theme-minimal-gray {
            font-family: 'Inter', sans-serif !important;
        }
        .theme-minimal-gray .display-font {
            font-family: 'Montserrat', sans-serif !important;
            font-weight: 300 !important;
            letter-spacing: 3px !important;
        }
        .theme-minimal-gray .content-font {
            font-family: 'Inter', sans-serif !important;
        }
        
        .theme-cream-rose {
            font-family: 'Lora', serif !important;
        }
        .theme-cream-rose .display-font {
            font-family: 'Dancing Script', cursive !important;
            font-weight: 700 !important;
        }
        .theme-cream-rose .content-font {
            font-family: 'Lora', serif !important;
        }

        body.theme-matcha-dreams::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Cdefs%3E%3Cstyle%3E.boba%7Bfill:%23A8C686;opacity:0.3%7D.ice%7Bfill:%23E8F5E8;opacity:0.4;stroke:%23A8C686;stroke-width:1%7D%3C/style%3E%3C/defs%3E%3Ccircle class='boba' cx='80' cy='80' r='12'/%3E%3Ccircle class='boba' cx='220' cy='120' r='10'/%3E%3Ccircle class='boba' cx='150' cy='200' r='14'/%3E%3Ccircle class='boba' cx='50' cy='250' r='8'/%3E%3Cpolygon class='ice' points='100,50 120,70 110,90 90,85'/%3E%3Cpolygon class='ice' points='200,180 225,200 210,225 185,210'/%3E%3Cpolygon class='ice' points='250,80 270,95 260,115 240,105'/%3E%3C/svg%3E");
            opacity: 0.2;
        }

        body.theme-warm-neutrals::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Cdefs%3E%3Cstyle%3E.petal%7Bfill:%23E8C5B5;opacity:0.3%7D.stem%7Bfill:none;stroke:%23D4B5A0;stroke-width:1.5;opacity:0.4%7D%3C/style%3E%3C/defs%3E%3Cpath class='stem' d='M150 150Q120 120 100 100M150 150Q180 120 200 100M150 150Q120 180 100 200M150 150Q180 180 200 200'/%3E%3Cellipse class='petal' cx='105' cy='105' rx='6' ry='12' transform='rotate(45 105 105)'/%3E%3Cellipse class='petal' cx='195' cy='105' rx='6' ry='12' transform='rotate(-45 195 105)'/%3E%3Cellipse class='petal' cx='105' cy='195' rx='6' ry='12' transform='rotate(-45 105 195)'/%3E%3Cellipse class='petal' cx='195' cy='195' rx='6' ry='12' transform='rotate(45 195 195)'/%3E%3C/svg%3E");
            opacity: 0.12;
        }

        body.theme-lavender-mist::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Cdefs%3E%3Cstyle%3E.cloud%7Bfill:%23D4D1D7;opacity:0.25%7D.star%7Bfill:%23C8C3D0;opacity:0.3%7D%3C/style%3E%3C/defs%3E%3Cellipse class='cloud' cx='80' cy='100' rx='30' ry='15'/%3E%3Cellipse class='cloud' cx='200' cy='80' rx='25' ry='12'/%3E%3Cellipse class='cloud' cx='120' cy='220' rx='35' ry='18'/%3E%3Cpath class='star' d='M150 50l3 9h9l-7 5 3 9-8-6-8 6 3-9-7-5h9z'/%3E%3Cpath class='star' d='M250 150l2 6h6l-5 4 2 6-5-4-5 4 2-6-5-4h6z'/%3E%3Cpath class='star' d='M60 200l2 6h6l-5 4 2 6-5-4-5 4 2-6-5-4h6z'/%3E%3C/svg%3E");
            opacity: 0.18;
        }

        body.theme-soft-beige::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Cdefs%3E%3Cstyle%3E.grain%7Bfill:%23E8D5C4;opacity:0.2%7D.texture%7Bfill:%23D4C0A8;opacity:0.15%7D%3C/style%3E%3C/defs%3E%3Ccircle class='grain' cx='80' cy='80' r='2'/%3E%3Ccircle class='grain' cx='220' cy='120' r='1.5'/%3E%3Ccircle class='grain' cx='150' cy='200' r='2.5'/%3E%3Ccircle class='grain' cx='50' cy='250' r='1'/%3E%3Ccircle class='texture' cx='180' cy='60' r='1'/%3E%3Ccircle class='texture' cx='100' cy='180' r='1.5'/%3E%3Ccircle class='texture' cx='250' cy='200' r='1'/%3E%3C/svg%3E");
            opacity: 0.1;
        }

        body.theme-minimal-gray::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Cdefs%3E%3Cstyle%3E.line%7Bstroke:%237A7A7A;stroke-width:0.5;opacity:0.2%7D%3C/style%3E%3C/defs%3E%3Cline class='line' x1='0' y1='100' x2='300' y2='100'/%3E%3Cline class='line' x1='0' y1='200' x2='300' y2='200'/%3E%3Cline class='line' x1='100' y1='0' x2='100' y2='300'/%3E%3Cline class='line' x1='200' y1='0' x2='200' y2='300'/%3E%3C/svg%3E");
            opacity: 0.08;
        }

        body.theme-cream-rose::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Cdefs%3E%3Cstyle%3E.rose%7Bfill:%23E8C5B5;opacity:0.25%7D.bud%7Bfill:%23D4A28F;opacity:0.2%7D%3C/style%3E%3C/defs%3E%3Ccircle class='rose' cx='150' cy='150' r='8'/%3E%3Ccircle class='bud' cx='100' cy='100' r='4'/%3E%3Ccircle class='bud' cx='200' cy='200' r='5'/%3E%3Ccircle class='bud' cx='80' cy='220' r='3'/%3E%3Ccircle class='bud' cx='220' cy='80' r='4'/%3E%3Cpath class='rose' d='M150 142c-4 0-8 4-8 8s4 8 8 8 8-4 8-8-4-8-8-8z' opacity='0.3'/%3E%3C/svg%3E");
            opacity: 0.15;
        }

        .display-font { 
            font-family: 'Playfair Display', serif;
            font-weight: 500;
            letter-spacing: -0.02em;
            color: var(--charcoal);
        }

        .content-font { 
            font-family: 'Inter', sans-serif; 
            font-weight: 400;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow-subtle);
        }
        
        .tab {
            background: var(--warm-white);
            border: 1px solid rgba(0,0,0,0.08);
            border-bottom: none;
            margin-bottom: -1px;
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s ease;
            border-radius: 12px 12px 0 0;
            position: relative;
        }

        .tab:hover {
            background: white;
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px);
        }

        .tab-active {
            background: white;
            border-color: var(--accent-soft, rgba(0,0,0,0.1));
            border-bottom-color: white !important;
            z-index: 10;
            box-shadow: var(--shadow-medium);
        }
        
        #main-content {
            background: white;
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 0 16px 16px 16px;
            box-shadow: var(--shadow-medium);
            position: relative;
            z-index: 1;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .day-cell {
            transition: all 0.2s ease;
            background: white;
            border: none;
            position: relative;
            min-height: 120px;
        }

        .day-cell:hover {
            background: var(--soft-beige);
            transform: none;
        }

        .day-cell.today {
            background: var(--nude-pink);
            position: relative;
        }

        .day-cell.today::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--dusty-rose);
            border-radius: 50%;
        }

        .event-bubble {
            transition: all 0.2s ease;
            border-radius: 6px;
            font-weight: 500;
            font-size: 11px;
            padding: 6px 8px;
            margin: 2px 0;
            border: none;
            color: var(--charcoal);
            background: var(--dusty-rose);
        }

        .event-bubble:hover {
            transform: none;
            opacity: 0.8;
        }

        .event-bubble-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .event-color-1 { background: var(--dusty-rose); }
        .event-color-2 { background: var(--sage-green); }
        .event-color-3 { background: var(--lavender-gray); }
        .event-color-4 { background: var(--nude-pink); }
        .event-color-5 { background: #E8D5C4; }
        .event-color-6 { background: #C8B5A6; }

        .daily-schedule {
            transition: transform 0.3s ease;
            transform: translateX(100%);
            background: white;
            border-left: 1px solid rgba(0,0,0,0.08);
        }

        .daily-schedule.open {
            transform: translateX(0);
        }

        .clean-btn {
            background: var(--charcoal);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .clean-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .clean-btn:hover {
            background: var(--dark-gray);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .clean-btn:hover::before {
            transform: translateX(100%);
        }

        .clean-btn:active {
            transform: translateY(0);
            transition-duration: 0.1s;
        }

        .clean-btn.secondary {
            background: var(--light-gray);
            color: var(--charcoal);
        }

        .clean-btn.secondary:hover {
            background: var(--medium-gray);
            color: white;
        }

        .clean-input {
            background: white;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            width: 100%;
        }

        .clean-input:focus {
            outline: none;
            border-color: var(--dusty-rose);
            box-shadow: 0 0 0 3px rgba(232, 197, 181, 0.1);
        }

        .clean-input::placeholder {
            color: var(--medium-gray);
        }

        /* Modal Glassmorphism Effects */
        .modal-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Enhanced Card Styles */
        .card-elevated {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-elevated:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
        }

        /* Subtle Animation Classes */
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Better Calendar Day Hover Effects */
        .day-cell {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .day-cell:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* Enhanced Input Focus States */
        .clean-input {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .clean-input:focus {
            outline: none;
            border-color: var(--dusty-rose);
            box-shadow: 0 0 0 4px rgba(232, 197, 181, 0.12);
            transform: translateY(-1px);
        }

        /* Daily Schedule Sidebar */
        .daily-schedule {
            transition: transform 0.3s ease;
            transform: translateX(100%);
            background: white;
            border-left: 1px solid rgba(0,0,0,0.08);
        }

        .daily-schedule.open {
            transform: translateX(0);
        }

        /* Mobile Responsiveness Improvements */
        @media (max-width: 768px) {
            .card-elevated {
                border-radius: 8px;
                margin: 0 -0.5rem;
            }
            
            .clean-btn {
                padding: 14px 20px;
                font-size: 15px;
                min-height: 48px;
            }
            
            .day-cell {
                min-height: 60px;
                font-size: 14px;
            }
            
            header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            header h1 {
                font-size: 2rem !important;
            }
            
            .chore-section-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem;
            }
        }

        /* Enhanced Focus States for Accessibility */
        .clean-btn:focus,
        .day-cell:focus {
            outline: 3px solid rgba(232, 197, 181, 0.5);
            outline-offset: 2px;
        }

        /* Loading State Improvements */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Clean Color Themes */
        .theme-warm-neutrals { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: var(--nude-pink); 
            --text-primary: var(--charcoal); 
            --accent: var(--dusty-rose); 
            --accent-soft: var(--nude-pink); 
        }
        .theme-sage-tones { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: var(--sage-green); 
            --text-primary: var(--charcoal); 
            --accent: var(--sage-green); 
            --accent-soft: #D4E5CE; 
        }
        .theme-lavender-mist { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: var(--lavender-gray); 
            --text-primary: var(--charcoal); 
            --accent: var(--lavender-gray); 
            --accent-soft: #E8E4EA; 
        }
        .theme-soft-beige { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: var(--soft-beige); 
            --text-primary: var(--charcoal); 
            --accent: #E8D5C4; 
            --accent-soft: var(--soft-beige); 
        }
        .theme-minimal-gray { 
            --bg-primary: var(--warm-white); 
            --bg-secondary: #F5F5F5; 
            --text-primary: var(--charcoal); 
            --accent: var(--medium-gray); 
            --accent-soft: #F5F5F5; 
        }
        .theme-cream-rose { 
            --bg-primary: var(--cream); 
            --bg-secondary: #F9F0ED; 
            --text-primary: var(--charcoal); 
            --accent: #E8C5B5; 
            --accent-soft: #F4E6E0; 
        }
        .theme-matcha-dreams { 
            --bg-primary: #F5F8F4; 
            --bg-secondary: #E0EDD8; 
            --text-primary: var(--charcoal); 
            --accent: #A8C686; 
            --accent-soft: #D4E5C0; 
        }
        
        .bg-primary { background: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .text-primary { color: var(--text-primary); }
        .accent { background-color: var(--accent); }
        .border-accent { border-color: var(--accent); }

        .weather-icon {
            transition: all 0.2s ease;
            filter: none;
        }

        .weather-icon:hover {
            transform: scale(1.05);
        }

        /* Floating decorative elements */
        .floating-element {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); }
            100% { transform: translateY(-100px) rotate(360deg); }
        }

        .floating-element.slow {
            animation-duration: 30s;
        }

        .floating-element.fast {
            animation-duration: 15s;
        }

        /* Enhanced theme transitions */
        body, #main-content, header {
            transition: background 0.8s ease, border-color 0.8s ease;
        }

        /* Sophisticated hover effects */
        .day-cell {
            position: relative;
            overflow: hidden;
        }

        .day-cell::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .day-cell:hover::after {
            left: 100%;
        }

        /* Voting System Styles */
        #view-toggle-btn.active, #voting-view-btn.active {
            background: var(--accent);
            color: white;
        }

        .poll-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 2px solid rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }

        .poll-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .poll-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .poll-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .poll-description {
            color: #6B7280;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .poll-date {
            font-size: 0.875rem;
            color: var(--accent);
            font-weight: 500;
        }

        .poll-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .vote-btn {
            flex: 1;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .vote-btn.yes {
            background: #10B981;
            color: white;
        }

        .vote-btn.yes:hover {
            background: #059669;
            transform: scale(1.02);
        }

        .vote-btn.no {
            background: #EF4444;
            color: white;
        }

        .vote-btn.no:hover {
            background: #DC2626;
            transform: scale(1.02);
        }

        .vote-btn.voted {
            border-color: white;
            box-shadow: 0 0 0 2px currentColor;
        }

        .vote-counts {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.875rem;
        }

        .vote-count {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .vote-count.yes {
            color: #10B981;
        }

        .vote-count.no {
            color: #EF4444;
        }

        .poll-creator {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-top: 8px;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-6 relative">
        <header class="flex items-center justify-between mb-8 card-elevated p-6 fade-in">
            <h1 class="display-font text-4xl">Calendar</h1>
            <div class="flex items-center gap-3">
            <div id="weather-widget" class="text-right content-font">
                    <div class="text-sm">
                        <p class="font-medium text-gray-700">Finding Location...</p>
                        <p class="text-gray-500">Loading weather...</p>
                </div>
                </div>
                <button id="notification-settings-btn" class="clean-btn px-3 py-2 text-xs" title="Notification Settings">
                    <span id="notification-icon">üîï</span> Notifications
                </button>
                <button id="session-btn" class="clean-btn px-3 py-2 text-xs" title="Session Info">
                    Session
                </button>
            </div>
        </header>

        <div id="tabs-container" class="flex items-end -mb-px relative mb-4">
            <button id="add-calendar-btn" class="clean-btn ml-3 flex items-center gap-2">
                <i class="fas fa-plus text-sm"></i>
                <span>Add Calendar</span>
            </button>
        </div>

        <div class="flex justify-center mb-6">
            <div class="card-elevated p-1 slide-up">
                <button id="view-toggle-btn" class="px-6 py-2 rounded-md font-medium transition-all duration-300" data-view="calendar">
                    <span id="view-icon">üìÖ</span> Calendar
                </button>
                <button id="voting-view-btn" class="px-6 py-2 rounded-md font-medium transition-all duration-300" data-view="voting">
                    <span id="voting-icon">üó≥Ô∏è</span> Voting
                </button>
                <button id="chores-view-btn" class="px-6 py-2 rounded-md font-medium transition-all duration-300" data-view="chores">
                    <span id="chores-icon">üßπ</span> Chores
                </button>
            </div>
        </div>

        <main id="main-content" class="card-elevated p-6 mb-6 slide-up">
            <div id="calendar-view">
            <div class="flex justify-between items-center mb-6">
                    <button id="prev-month" class="clean-btn secondary p-3">
                        <i class="fas fa-chevron-left"></i>
                </button>
                    <h2 id="month-year" class="text-3xl font-medium display-font"></h2>
                    <button id="next-month" class="clean-btn secondary p-3">
                        <i class="fas fa-chevron-right"></i>
                </button>
            </div>
                <div class="grid grid-cols-7 gap-0 text-center text-sm font-medium mb-4 text-gray-600">
                    <div class="py-3">Sun</div>
                    <div class="py-3">Mon</div>
                    <div class="py-3">Tue</div>
                    <div class="py-3">Wed</div>
                    <div class="py-3">Thu</div>
                    <div class="py-3">Fri</div>
                    <div class="py-3">Sat</div>
            </div>
                <div id="calendar-grid" class="calendar-grid mb-8">
                    </div>
            </div>

            <div id="voting-view" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-medium display-font">üó≥Ô∏è Voting & Polls</h2>
                    <button id="create-poll-btn" class="clean-btn">
                        <i class="fas fa-plus mr-2"></i>Create Poll
                    </button>
                </div>
                <div id="polls-container" class="space-y-4">
                    </div>
            </div>

            <div id="chores-view" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-medium display-font">üßπ Weekly Chores</h2>
                    <button id="add-chore-btn" class="clean-btn">
                        <i class="fas fa-plus mr-2"></i>Add Chore
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="chore-section-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Unclaimed Chores -->
                        <div class="card-elevated p-5 bg-gradient-to-br from-gray-50 to-gray-100">
                            <h3 class="font-semibold mb-4 text-gray-700 flex items-center gap-2">
                                <span class="text-lg">üìã</span> Available Chores
                            </h3>
                            <div id="unclaimed-chores" class="space-y-2">
                                <!-- Unclaimed chores will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Claimed Chores -->
                        <div class="card-elevated p-5 bg-gradient-to-br from-blue-50 to-blue-100">
                            <h3 class="font-semibold mb-4 text-blue-700 flex items-center gap-2">
                                <span class="text-lg">üë§</span> Claimed Chores
                            </h3>
                            <div id="claimed-chores" class="space-y-2">
                                <!-- Claimed chores will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Completed Chores -->
                        <div class="card-elevated p-5 bg-gradient-to-br from-green-50 to-green-100">
                            <h3 class="font-semibold mb-4 text-green-700 flex items-center gap-2">
                                <span class="text-lg">‚úÖ</span> Completed Chores
                            </h3>
                            <div id="completed-chores" class="space-y-2">
                                <!-- Completed chores will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="daily-schedule" class="daily-schedule fixed top-0 right-0 h-full w-full md:w-96 p-6 z-50 overflow-y-auto">
        <div class="flex justify-between items-center mb-6 bg-white rounded-lg p-4 shadow-sm border">
            <h3 class="text-xl font-medium content-font" id="schedule-date">Schedule</h3>
            <button id="close-schedule" class="clean-btn secondary p-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="schedule-content" class="space-y-2 mb-6">
        </div>
        <div class="bg-white rounded-lg p-6 shadow-sm border">
            <h4 class="font-medium mb-4 content-font">Add New Event</h4>
            <input type="text" id="schedule-event-input" class="clean-input mb-3" placeholder="Event name...">
            <input type="time" id="schedule-event-time" class="clean-input mb-4">
            <button id="schedule-add-event-btn" class="clean-btn w-full">
                Add Event
            </button>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

                <div id="user-setup-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 modal-glass rounded-xl shadow-2xl p-8 z-50 hidden w-96 slide-up">
                <h3 class="text-2xl font-medium mb-4 content-font">üîó Join a Calendar Session</h3>
                <p class="text-gray-600 mb-4">To sync your calendar, please enter a session code. Use the same code on all your devices.</p>
                <input type="text" id="user-sync-code" placeholder="e.g., 'family-vacation' or 'work-team'" class="clean-input mb-4">
                <div class="flex justify-end gap-3">
                    <button id="setup-sync" class="clean-btn">Join Session üîÑ</button>
            </div>
            </div>

            <!-- Session Info Modal -->
            <div id="session-info-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 modal-glass rounded-xl shadow-2xl p-8 z-50 hidden w-96 slide-up">
                <h3 class="text-2xl font-medium mb-4 content-font">üë§ Current Session</h3>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="mb-2">
                        <span class="font-medium">Session Code:</span>
                        <span class="ml-2 text-blue-600 font-mono" id="current-session-display">Loading...</span>
            </div>
                    <div class="text-sm text-gray-600">
                        This code syncs your calendars across all devices
            </div>
            </div>

                <div class="space-y-3 mb-6">
                    <button id="switch-session-btn" class="clean-btn w-full">
                        üîÑ Switch to Different Session
                    </button>
            </div>

                <div class="flex justify-end">
                    <button id="close-session-modal" class="clean-btn secondary">Close</button>
        </div>
            </div>

            <div id="create-poll-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 modal-glass rounded-xl shadow-2xl p-8 z-50 hidden w-96 slide-up">
                <h3 class="text-2xl font-medium mb-4 content-font">üó≥Ô∏è Create New Poll</h3>
                <input type="text" id="poll-title" placeholder="Poll title (e.g., Movie Night)" class="clean-input mb-4">
                <textarea id="poll-description" placeholder="Description (optional)" class="clean-input mb-4 h-20 resize-none"></textarea>
                <input type="datetime-local" id="poll-date" class="clean-input mb-4">
                <div class="flex gap-2 mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="poll-is-event" class="mr-2">
                        <span class="text-sm">Create as calendar event</span>
                    </label>
                </div>
                <div class="flex justify-end gap-3">
                    <button id="cancel-create-poll" class="clean-btn secondary">Cancel</button>
                    <button id="confirm-create-poll" class="clean-btn">Create Poll ‚ú®</button>
        </div>
    </div>

            <!-- Add Chore Modal -->
            <div id="add-chore-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 modal-glass rounded-xl shadow-2xl p-8 z-50 hidden w-96 slide-up">
                <h3 class="text-2xl font-medium mb-4 content-font">üßπ Add New Chore</h3>
                <input type="text" id="chore-title" placeholder="Chore name (e.g., Clean kitchen)" class="clean-input mb-4">
                <textarea id="chore-description" placeholder="Description (optional)" class="clean-input mb-4 h-20 resize-none"></textarea>
                <select id="chore-difficulty" class="clean-input mb-4">
                    <option value="easy">Easy (5-15 min)</option>
                    <option value="medium">Medium (15-30 min)</option>
                    <option value="hard">Hard (30+ min)</option>
                </select>
                <div class="flex justify-end gap-3">
                    <button id="cancel-add-chore" class="clean-btn secondary">Cancel</button>
                    <button id="confirm-add-chore" class="clean-btn">Add Chore ‚ú®</button>
        </div>
            </div>

            <div id="notification-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-8 z-50 hidden w-96 border">
                <h3 class="text-2xl font-medium mb-4 content-font">üì± Enable Notifications?</h3>
                <p class="text-gray-600 mb-6">Get cute reminders for your upcoming events! We'll notify you 15 and 5 minutes before each event.</p>
                <div class="flex justify-end gap-3">
                    <button id="deny-notifications" class="clean-btn secondary">No Thanks</button>
                    <button id="enable-notifications" class="clean-btn">Yes, Notify Me! üîî</button>
                </div>
            </div>

            <div id="add-calendar-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-8 z-50 hidden w-96 border">
        <h3 class="text-2xl font-medium mb-6 content-font">Create New Calendar</h3>
        <input type="text" id="new-calendar-name" placeholder="Calendar Name (e.g., John's Calendar)" class="clean-input mb-6">
        <p class="font-medium mb-4 content-font">Choose a color scheme:</p>
        <div class="grid grid-cols-2 gap-3 mb-6">
                                        <div class="color-scheme-option cursor-pointer" data-theme="theme-warm-neutrals">
                                <div class="w-16 h-16 rounded-2xl shadow-lg flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #FDF2E9, #FAE5D3);">üå∏</div>
                                <p class="mt-2 text-sm font-bold content-font" style="color: #D2691E;">Peachy Dreams</p>
                            </div>
                            
                            <div class="color-scheme-option cursor-pointer" data-theme="theme-sage-tones">
                                <div class="w-16 h-16 rounded-2xl shadow-lg flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #E8F5E8, #D4E4D4);">üåø</div>
                                <p class="mt-2 text-sm font-bold content-font" style="color: #4A7C59;">Forest Whisper</p>
                            </div>
                            
                            <div class="color-scheme-option cursor-pointer" data-theme="theme-matcha-dreams">
                                <div class="w-16 h-16 rounded-2xl shadow-lg flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #F0F8E8, #E8F5D8);">üßã</div>
                                <p class="mt-2 text-sm font-bold content-font" style="color: #7CB342;">Matcha Latte</p>
                            </div>
                            
                            <div class="color-scheme-option cursor-pointer" data-theme="theme-lavender-mist">
                                <div class="w-16 h-16 rounded-2xl shadow-lg flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #F3E5F5, #E1BEE7);">üíú</div>
                                <p class="mt-2 text-sm font-bold content-font" style="color: #8E24AA;">Lavender Fields</p>
                            </div>
                            
                            <div class="color-scheme-option cursor-pointer" data-theme="theme-soft-beige">
                                <div class="w-16 h-16 rounded-2xl shadow-lg flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #FFF8E1, #F5E6A8);">‚òï</div>
                                <p class="mt-2 text-sm font-bold content-font" style="color: #A1887F;">Vanilla Latte</p>
                            </div>
                            
                            <div class="color-scheme-option cursor-pointer" data-theme="theme-minimal-gray">
                                <div class="w-16 h-16 rounded-2xl shadow-lg flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #ECEFF1, #CFD8DC);">‚ö™</div>
                                <p class="mt-2 text-sm font-bold content-font" style="color: #455A64;">Stone Minimal</p>
                            </div>
                            
                            <div class="color-scheme-option cursor-pointer" data-theme="theme-cream-rose">
                                <div class="w-16 h-16 rounded-2xl shadow-lg flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #FCE4EC, #F8BBD9);">üåπ</div>
                                <p class="mt-2 text-sm font-bold content-font" style="color: #AD1457;">Rose Garden</p>
                            </div>
        </div>
        <div class="flex justify-end gap-3">
            <button id="cancel-add-calendar" class="clean-btn secondary">Cancel</button>
            <button id="confirm-add-calendar" class="clean-btn">Create</button>
        </div>
    </div>

    <div id="add-event-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-8 z-50 hidden w-96 border">
        <h3 class="text-2xl font-medium mb-6 content-font">Add Event for <span id="event-modal-date" class="font-normal text-gray-600"></span></h3>
        <input type="text" id="event-name-input" placeholder="Event Name" class="clean-input mb-6">
        <p class="font-medium mb-4 content-font">Event Color:</p>
        <div id="event-colors" class="flex gap-2 mb-6">
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-1" data-color="event-color-1"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-2" data-color="event-color-2"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-3" data-color="event-color-3"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-4" data-color="event-color-4"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-5" data-color="event-color-5"></div>
            <div class="w-8 h-8 rounded cursor-pointer transition-all duration-200 hover:scale-110 event-color-6" data-color="event-color-6"></div>
        </div>
        <p class="font-medium mb-4 content-font">Link with another calendar (optional):</p>
        <select id="link-calendar-select" class="clean-input mb-6">
            <option value="">None</option>
        </select>
        <div class="flex justify-end gap-3">
            <button id="cancel-add-event" class="clean-btn secondary">Cancel</button>
            <button id="save-event" class="clean-btn">Save Event</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
            // --- STATE MANAGEMENT ---
                                                 state: {
                currentDate: new Date(),
                calendars: [],
                activeCalendarId: null,
                    weatherData: {},
                    visibleCalendars: new Set(), // Track which calendars are visible for overlay
                    notificationsEnabled: false,
                    notificationTimes: [15, 5], // Notify 15 and 5 minutes before events
                    scheduledNotifications: new Map(), // Track scheduled notifications
                    userKey: null,
                    polls: [], // Store all polls/voting events
                    chores: [], // Store all chores/tasks
                    currentView: 'calendar' // 'calendar', 'voting', or 'chores'
                },

            // --- DOM ELEMENTS ---
                elements: {},

                // --- CONSTANTS & CONFIG -- -
                config: {
                    WEATHER_API_KEY: '973209301a5a4be53a5337c204db93c2',
                    // IMPORTANT: REPLACE WITH YOUR FIREBASE PROJECT URL
                    FIREBASE_URL: 'https://calendar-69b17-default-rtdb.firebaseio.com/',
                    months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                                         colorSchemes: {
                         'theme-warm-neutrals': { 
                             bg: 'linear-gradient(135deg, #FDF8F4 0%, #FAF0E8 100%)', 
                             secondary: '#F9EDE5', 
                             text: '#A0744D', 
                             accent: '#E8B89B', 
                             'accent-soft': '#F2D4C2',
                             bodyClass: 'theme-warm-neutrals',
                             icon: 'üå∏',
                             name: 'Peachy Dreams'
                         },
                         'theme-sage-tones': { 
                             bg: 'linear-gradient(135deg, #F2F8F2 0%, #E8F5E8 100%)', 
                             secondary: '#E0F2E0', 
                             text: '#5A7A5A', 
                             accent: '#A5C4A5', 
                             'accent-soft': '#C8E6C8',
                             bodyClass: 'theme-sage-tones',
                             icon: 'üåø',
                             name: 'Forest Whisper'
                         },
                         'theme-matcha-dreams': { 
                             bg: 'linear-gradient(135deg, #F5FAF3 0%, #EEFAE8 100%)', 
                             secondary: '#E8F5E0', 
                             text: '#6B8E6B', 
                             accent: '#B8D4A8', 
                             'accent-soft': '#D5E8C8',
                             bodyClass: 'theme-matcha-dreams',
                             icon: 'üßã',
                             name: 'Matcha Latte'
                         },
                         'theme-lavender-mist': { 
                             bg: 'linear-gradient(135deg, #F8F5FA 0%, #F0E8F5 100%)', 
                             secondary: '#EBE0F0', 
                             text: '#8B6B9E', 
                             accent: '#C5A8D4', 
                             'accent-soft': '#DBC8E6',
                             bodyClass: 'theme-lavender-mist',
                             icon: 'üíú',
                             name: 'Lavender Fields'
                         },
                         'theme-soft-beige': { 
                             bg: 'linear-gradient(135deg, #FEFBF5 0%, #FAF4E8 100%)', 
                             secondary: '#F7F0E0', 
                             text: '#A08B7A', 
                             accent: '#D2C0A8', 
                             'accent-soft': '#E5D8C8',
                             bodyClass: 'theme-soft-beige',
                             icon: '‚òï',
                             name: 'Vanilla Latte'
                         },
                         'theme-minimal-gray': { 
                             bg: 'linear-gradient(135deg, #F8F9FA 0%, #F0F2F5 100%)', 
                             secondary: '#E8EAED', 
                             text: '#6B7280', 
                             accent: '#B0B8C4', 
                             'accent-soft': '#D1D5DB',
                             bodyClass: 'theme-minimal-gray',
                             icon: '‚ö™',
                             name: 'Stone Minimal'
                         },
                         'theme-cream-rose': { 
                             bg: 'linear-gradient(135deg, #FDF5F8 0%, #FAE8F0 100%)', 
                             secondary: '#F5DDE8', 
                             text: '#A8708A', 
                             accent: '#D4A8C2', 
                             'accent-soft': '#E6C8D8',
                             bodyClass: 'theme-cream-rose',
                             icon: 'üåπ',
                             name: 'Rose Garden'
                         }
                    }
                },

                // --- DATA PERSISTENCE & SYNC ---
                async syncToCloud(data) {
                    try {
                        const userKey = this.getUserKey();
                        if (!userKey) return;
                        
                        await fetch(`${this.config.FIREBASE_URL}calendars/${userKey}.json`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    } catch (error) {
                        console.error('Sync to cloud failed:', error);
                    }
                },
                
                async loadFromCloud() {
                    try {
                        const userKey = this.getUserKey();
                        if (!userKey) return null;
                        
                        const response = await fetch(`${this.config.FIREBASE_URL}calendars/${userKey}.json`);
                        if (response.ok) {
                            return await response.json();
                        }
                        return null;
                    } catch (error) {
                        console.error('Load from cloud failed:', error);
                        return null;
                    }
                },

                saveState() {
                    try {
                        const stateToSave = {
                            ...this.state,
                            visibleCalendars: Array.from(this.state.visibleCalendars),
                            scheduledNotifications: {},
                            lastModified: Date.now(),
                            version: '2.0'
                        };
                        
                        localStorage.setItem('calendarAppState', JSON.stringify(stateToSave));
                        this.syncToCloud(stateToSave);
                    } catch (error) {
                        console.error('Failed to save state:', error);
                    }
                },

                async loadState() {
                    const cloudData = await this.loadFromCloud();

                    if (cloudData) {
                        this.state = {
                            ...this.state, // keep defaults
                            ...cloudData,
                            currentDate: new Date(cloudData.currentDate),
                            visibleCalendars: new Set(cloudData.visibleCalendars),
                        };
                        
                        if(this.state.calendars && this.state.calendars.length > 0 && !this.state.activeCalendarId) {
                            this.state.activeCalendarId = this.state.calendars[0].id;
                        }
                        console.log('‚úÖ State loaded from cloud.');
                } else {
                        console.log('üÜï No cloud data found for this session, starting fresh.');
                    }
                },
                
                getUserKey() {
                    return this.state.userKey || localStorage.getItem('calendarUserKey');
                },
                
                                 setUserKey(userKey) {
                     localStorage.setItem('calendarUserKey', userKey);
                     this.state.userKey = userKey;
                     
                     this.loadState().then(() => {
                         this.renderTabs();
                         this.renderCalendar();
                     });
                 },

                 openSessionInfoModal() {
                     const modal = document.getElementById('session-info-modal');
                     const sessionDisplay = document.getElementById('current-session-display');
                     
                     if (sessionDisplay) {
                         const userKey = this.getUserKey();
                         if (userKey) {
                             // Show just the session code without technical prefixes
                             sessionDisplay.textContent = userKey;
                         } else {
                             sessionDisplay.textContent = 'No session active';
                         }
                     }
                     
                     this.openModal(modal);
                 },

                 switchToNewSession() {
                     // Clear current session data
                     localStorage.removeItem('calendarAppState');
                     localStorage.removeItem('calendarUserKey');
                     
                     // Reset state
                     this.state = {
                         currentDate: new Date(),
                         calendars: [],
                         activeCalendarId: null,
                         weatherData: {},
                         visibleCalendars: new Set(),
                         notificationsEnabled: false,
                         notificationTimes: [15, 5],
                         scheduledNotifications: new Map(),
                         userKey: null,
                         polls: [],
                         chores: [],
                         currentView: 'calendar'
                     };
                     
                     // Close current modal and show setup
                     this.closeModal(document.getElementById('session-info-modal'));
                     this.showUserSetupModal();
                 },

            // --- WEATHER API ---
                async getWeatherData(lat, lon, cityName) {
                document.querySelector('#weather-widget p:first-child').textContent = cityName;
                    if (!this.config.WEATHER_API_KEY) {
                    console.warn("Weather API key is missing.");
                    document.querySelector('#weather-widget p:last-child').textContent = 'API Key needed';
                    return;
                }
                    const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${this.config.WEATHER_API_KEY}&units=imperial`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (!response.ok || !data.list || data.list.length === 0) {
                        console.error("Weather API error or empty response:", data);
                        let errorMessage = 'Weather data unavailable';
                        if (data && data.message) {
                             errorMessage = `Weather Error: ${data.message}`;
                        }
                        document.querySelector('#weather-widget p:last-child').textContent = errorMessage;
                        return;
                    }

                    document.querySelector('#weather-widget p:last-child').textContent = 
                            `${Math.round(data.list[0].main.temp)}¬∞F, ${data.list[0].weather[0].main}`;

                        this.state.weatherData = {};
                    const dailyData = {};
                    data.list.forEach(item => {
                        const date = new Date(item.dt * 1000);
                        const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                        if (!dailyData[dateKey] || date.getHours() === 12) {
                             dailyData[dateKey] = {
                                temp: Math.round(item.main.temp),
                                icon: item.weather[0].icon
                            };
                        }
                    });
                        this.state.weatherData = dailyData;

                        this.renderCalendar();
                } catch (error) {
                    console.error("Error fetching weather data:", error);
                    document.querySelector('#weather-widget p:last-child').textContent = 'Weather unavailable';
                }
                },
            
                getLocationAndFetchWeather() {
                 if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        let cityName = "Your Location";
                            if(this.config.WEATHER_API_KEY) {
                            try {
                                    const geoUrl = `https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${this.config.WEATHER_API_KEY}`;
                                const geoResponse = await fetch(geoUrl);
                                const geoData = await geoResponse.json();
                                if(geoData[0]) cityName = geoData[0].name;
                            } catch (e) { console.error("Could not reverse geocode."); }
                        }
                            this.getWeatherData(lat, lon, cityName);
                    }, () => {
                            this.getWeatherData(51.5072, -0.1276, "London, UK");
                    });
                } else {
                        this.getWeatherData(51.5072, -0.1276, "London, UK");
                    }
                },

                // --- THEME APPLICATION ---
                                 applyFullPageTheme(theme) {
                     const root = document.documentElement;
                     root.style.setProperty('--bg-primary', theme.bg);
                     root.style.setProperty('--bg-secondary', theme.secondary);
                     root.style.setProperty('--text-primary', theme.text);
                     root.style.setProperty('--accent', theme.accent);
                     root.style.setProperty('--accent-soft', theme['accent-soft']);
                     
                     const mainContent = document.getElementById('main-content');
                     mainContent.style.background = theme.bg;
                     mainContent.style.borderColor = theme['accent-soft'];
                     mainContent.style.borderWidth = '4px';
                     mainContent.style.borderRadius = '24px';
                     mainContent.style.boxShadow = `0 24px 80px ${theme.accent}15`;
                     
                     document.body.className = theme.bodyClass;
                     document.body.style.background = theme.bg;
                     
                     // Apply theme-specific typography
                     const allElements = document.querySelectorAll('*');
                     allElements.forEach(el => {
                         if (el.classList.contains('display-font')) {
                             el.style.color = theme.accent;
                         }
                         if (el.classList.contains('content-font')) {
                             el.style.color = theme.text;
                         }
                     });
                     
                     const header = document.querySelector('header');
                     if (header) {
                         header.style.background = `linear-gradient(135deg, ${theme.secondary}DD, ${theme['accent-soft']}BB)`;
                         header.style.backdropFilter = 'blur(24px)';
                         header.style.borderColor = theme['accent-soft'];
                         header.style.borderWidth = '3px';
                         header.style.borderRadius = '20px';
                         header.style.color = theme.text;
                     }
                     
                     // Update page title with theme icon
                     const pageTitle = document.querySelector('h1');
                     if (pageTitle) {
                         pageTitle.innerHTML = `${theme.icon} Family Calendar ${theme.icon}`;
                         pageTitle.style.color = theme.accent;
                     }
                 },

            // --- CORE RENDER FUNCTIONS ---
                                 renderCalendar() {
                     const date = this.state.currentDate;
                const year = date.getFullYear();
                const month = date.getMonth();

                     this.elements.monthYearHeader.textContent = `${this.config.months[month]} ${year}`;
                     this.elements.calendarGrid.innerHTML = '';

                     // If no calendars exist, show a message
                     if (this.state.calendars.length === 0) {
                         const welcomeMessage = document.createElement('div');
                         welcomeMessage.className = 'col-span-7 text-center py-12';
                         welcomeMessage.innerHTML = `
                             <div class="text-6xl mb-4">üå∏</div>
                             <h2 class="text-2xl font-bold mb-2 display-font">Welcome to Your Calendar!</h2>
                             <p class="text-gray-600 mb-6">Create your first calendar to get started</p>
                             <button onclick="app.openAddCalendarModal()" class="clean-btn">
                                 <i class="fas fa-plus mr-2"></i>Create Your First Calendar
                             </button>
                         `;
                         this.elements.calendarGrid.appendChild(welcomeMessage);
                         return;
                     }

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                     const activeCalendar = this.state.calendars.find(c => c.id === this.state.activeCalendarId);
                
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'p-2 border rounded-2xl bg-gray-50 opacity-50';
                        this.elements.calendarGrid.appendChild(cell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('div');
                    const fullDate = new Date(year, month, day);
                    const dateKey = `${year}-${month}-${day}`;
                    
                    cell.className = 'day-cell p-4 flex flex-col cursor-pointer min-h-[140px] group';
                    cell.dataset.date = fullDate.toISOString();
                    
                    const today = new Date();
                    if (date.getFullYear() === today.getFullYear() && date.getMonth() === today.getMonth() && day === today.getDate()) {
                             cell.classList.add('today');
                             cell.style.background = this.config.colorSchemes[activeCalendar.theme].secondary;
                             cell.style.border = `5px solid ${this.config.colorSchemes[activeCalendar.theme]['accent-soft']}`;
                             cell.style.borderRadius = '16px';
                             cell.style.boxShadow = `0 12px 35px ${this.config.colorSchemes[activeCalendar.theme].accent}20`;
                             
                             // Add today indicator
                             const todayBadge = document.createElement('div');
                             todayBadge.innerHTML = `${this.config.colorSchemes[activeCalendar.theme].icon} TODAY`;
                             todayBadge.className = 'absolute top-2 right-2 text-xs font-bold px-3 py-1 rounded-full';
                             todayBadge.style.background = this.config.colorSchemes[activeCalendar.theme]['accent-soft'];
                             todayBadge.style.color = this.config.colorSchemes[activeCalendar.theme].text;
                             cell.style.position = 'relative';
                             cell.appendChild(todayBadge);
                    }
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'flex justify-between items-start mb-2';

                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'font-bold text-xl content-font text-gray-700';
                    dayNumber.textContent = day;
                    dayHeader.appendChild(dayNumber);
                    
                        if(this.state.weatherData[dateKey]) {
                        const weatherContainer = document.createElement('div');
                        weatherContainer.className = 'flex flex-col items-center text-xs text-gray-600';
                        const weatherIcon = document.createElement('img');
                            weatherIcon.src = `https://openweathermap.org/img/wn/${this.state.weatherData[dateKey].icon}.png`;
                        weatherIcon.className = 'w-8 h-8 weather-icon';
                        weatherContainer.appendChild(weatherIcon);
                        const tempSpan = document.createElement('span');
                            tempSpan.textContent = `${this.state.weatherData[dateKey].temp}¬∞F`;
                        tempSpan.className = 'font-semibold';
                        weatherContainer.appendChild(tempSpan);
                        dayHeader.appendChild(weatherContainer);
                    }
                    cell.appendChild(dayHeader);

                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'flex-1 space-y-2 overflow-y-auto text-xs';
                    
                                                 // Collect all events for this date from active calendar and visible calendars
                         const allEvents = [];
                         let hasEvents = false;
                         
                         // Add events from active calendar
                    if (activeCalendar && activeCalendar.events && activeCalendar.events[dateKey]) {
                             hasEvents = true;
                        activeCalendar.events[dateKey].forEach(event => {
                                 allEvents.push({
                                     ...event,
                                     calendarId: activeCalendar.id,
                                     calendarName: activeCalendar.name,
                                     calendarTheme: activeCalendar.theme,
                                     isActive: true
                                 });
                             });
                         }
                         
                         // Add events from visible calendars (overlay)
                         this.state.visibleCalendars.forEach(visibleCalendarId => {
                             const visibleCalendar = this.state.calendars.find(c => c.id === visibleCalendarId);
                             if (visibleCalendar && visibleCalendar.events && visibleCalendar.events[dateKey]) {
                                 hasEvents = true;
                                 visibleCalendar.events[dateKey].forEach(event => {
                                     allEvents.push({
                                         ...event,
                                         calendarId: visibleCalendar.id,
                                         calendarName: visibleCalendar.name,
                                         calendarTheme: visibleCalendar.theme,
                                         isActive: false
                                     });
                                 });
                             }
                         });
                         
                         if (hasEvents) {
                             cell.style.background = `linear-gradient(135deg, ${this.config.colorSchemes[activeCalendar.theme].secondary}, ${this.config.colorSchemes[activeCalendar.theme]['accent-soft']})`;
                             cell.style.border = `3px solid ${this.config.colorSchemes[activeCalendar.theme]['accent-soft']}`;
                             cell.style.borderRadius = '14px';
                             
                             // Sort events: active calendar first, then by time
                             allEvents.sort((a, b) => {
                                 if (a.isActive && !b.isActive) return -1;
                                 if (!a.isActive && b.isActive) return 1;
                                 return new Date(a.date) - new Date(b.date);
                             });
                             
                             allEvents.forEach(event => {
                            const eventEl = document.createElement('div');
                                 eventEl.className = `event-bubble ${event.color} flex items-center justify-between ${!event.isActive ? 'overlay-event' : ''}`;
                            if(event.completed) eventEl.classList.add('event-bubble-completed');
                            
                            const eventText = document.createElement('span');
                                 const calendarIcon = this.config.colorSchemes[event.calendarTheme].icon;
                                 eventText.innerHTML = `${event.isActive ? this.getDayTimeIcon() : calendarIcon} ${event.name}`;
                                 eventText.style.fontWeight = event.isActive ? '600' : '500';
                                 if (!event.isActive) {
                                     eventText.innerHTML += ` <span class="text-xs opacity-60">(${event.calendarName})</span>`;
                                 }
                            eventEl.appendChild(eventText);

                                 // Only add checkbox for active calendar events
                                 if (event.isActive) {
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = event.completed;
                            checkbox.className = 'ml-2 w-4 h-4 rounded-full';
                                     checkbox.style.accentColor = this.config.colorSchemes[activeCalendar.theme]['accent-soft'];
                            checkbox.onchange = (e) => {
                                e.stopPropagation();
                                         this.toggleEventCompletion(event.id);
                            };
                            eventEl.appendChild(checkbox);
                                 }
                            eventsContainer.appendChild(eventEl);
                        });
                    }
                    cell.appendChild(eventsContainer);

                    const addBtn = document.createElement('button');
                         addBtn.innerHTML = `<span class="text-2xl">${this.getDayTimeIcon()}</span>`;
                         addBtn.className = 'self-center mt-auto opacity-0 group-hover:opacity-100 transition-all duration-300 hover:scale-110';
                         addBtn.style.color = this.config.colorSchemes[activeCalendar.theme].text;
                         addBtn.style.background = `${this.config.colorSchemes[activeCalendar.theme]['accent-soft']}`;
                         addBtn.style.borderRadius = '50%';
                         addBtn.style.width = '44px';
                         addBtn.style.height = '44px';
                         addBtn.style.display = 'flex';
                         addBtn.style.alignItems = 'center';
                         addBtn.style.justifyContent = 'center';
                         addBtn.style.border = `3px solid ${this.config.colorSchemes[activeCalendar.theme]['accent-soft']}`;
                    addBtn.onclick = (e) => {
                        e.stopPropagation();
                            this.openAddEventModal(fullDate);
                    };
                    cell.appendChild(addBtn);
                    
                        cell.onclick = () => this.openDailySchedule(fullDate);

                        this.elements.calendarGrid.appendChild(cell);
                    }
                },

                                 renderTabs() {
                     const addBtn = this.elements.addCalendarBtn;
                     const notificationBtn = document.getElementById('notification-settings-btn');
                     this.elements.tabsContainer.innerHTML = '';
                     
                     this.state.calendars.forEach(calendar => {
                    const tab = document.createElement('button');
                         tab.className = `tab px-6 py-3 font-medium text-sm transition-all duration-300 content-font`;
                         
                         const theme = this.config.colorSchemes[calendar.theme];
                         
                         // Add theme icon and styled text
                         const isVisible = this.state.visibleCalendars.has(calendar.id);
                         tab.innerHTML = `
                             <div class="flex items-center justify-between w-full">
                                 <div class="flex items-center">
                                     <span class="text-lg mr-2">${theme.icon}</span>
                                     <div>
                                         <span class="font-semibold">${calendar.name}</span>
                                         <div class="text-xs opacity-75 mt-1">${theme.name}</div>
                                     </div>
                                 </div>
                                 ${calendar.id !== this.state.activeCalendarId ? `
                                     <label class="toggle-switch ml-3 flex-shrink-0" onclick="event.stopPropagation()">
                                         <input type="checkbox" ${isVisible ? 'checked' : ''} onchange="event.stopPropagation(); app.toggleCalendarVisibility('${calendar.id}')">
                                         <span class="toggle-slider"></span>
                                     </label>
                                 ` : ''}
                             </div>
                         `;
                    tab.dataset.calendarId = calendar.id;
                    
                         if (calendar.id === this.state.activeCalendarId) {
                        tab.classList.add('tab-active');
                        tab.style.background = theme.bg;
                        tab.style.color = theme.text;
                        tab.style.borderColor = theme['accent-soft'];
                             tab.style.borderWidth = '4px';
                             tab.style.borderRadius = '16px';
                             tab.style.boxShadow = `0 12px 40px ${theme.accent}25`;
                             
                             this.applyFullPageTheme(theme);

                    } else {
                             tab.style.background = 'rgba(255,255,255,0.7)';
                             tab.style.color = '#6B7280';
                             tab.style.borderColor = 'rgba(0,0,0,0.08)';
                             tab.style.borderWidth = '1px';
                             tab.style.boxShadow = 'none';
                         }

                         tab.onclick = () => this.switchCalendar(calendar.id);
                         this.elements.tabsContainer.appendChild(tab);
                     });
                     
                     this.elements.tabsContainer.appendChild(addBtn);
                     if (notificationBtn) {
                         this.elements.tabsContainer.appendChild(notificationBtn);
                     }
                 },

                renderDailySchedule(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();
                const dateKey = `${year}-${month}-${day}`;
                
                    this.elements.scheduleDateHeader.textContent = `üìÖ ${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`;
                    this.elements.scheduleContent.innerHTML = '';

                    const activeCalendar = this.state.calendars.find(c => c.id === this.state.activeCalendarId);
                const events = (activeCalendar && activeCalendar.events[dateKey]) ? [...activeCalendar.events[dateKey]] : [];
                events.sort((a,b) => new Date(a.date) - new Date(b.date));

                for (let hour = 0; hour < 24; hour++) {
                    const hourEl = document.createElement('div');
                    hourEl.className = 'flex mb-3';
                    
                    const timeEl = document.createElement('div');
                    timeEl.className = 'w-20 text-sm text-purple-600 pr-3 text-right font-bold content-font glass-effect rounded-l-2xl p-2 flex items-center justify-center';
                    const timeIcon = hour < 6 ? 'üåô' : hour < 12 ? 'üåÖ' : hour < 18 ? '‚òÄÔ∏è' : 'üåÜ';
                    timeEl.innerHTML = `${timeIcon}<br>${hour % 12 === 0 ? 12 : hour % 12} ${hour < 12 ? 'AM' : 'PM'}`;
                    
                    const slotEl = document.createElement('div');
                    slotEl.className = 'flex-1 glass-effect rounded-r-2xl p-3 min-h-[60px] flex flex-col justify-center';
                    
                    const eventsThisHour = events.filter(e => new Date(e.date).getHours() === hour);

                    if (eventsThisHour.length === 0) {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'text-gray-400 text-sm content-font text-center';
                        emptySlot.textContent = '‚ú® Free time';
                        slotEl.appendChild(emptySlot);
                    } else {
                        eventsThisHour.forEach(event => {
                            const eventDiv = document.createElement('div');
                            eventDiv.innerHTML = `<strong>${new Date(event.date).getMinutes().toString().padStart(2, '0')}:</strong> ${event.name}`;
                            eventDiv.className = `text-sm p-3 rounded-2xl text-white font-semibold mb-2 last:mb-0 shadow-md`;
                            eventDiv.style.background = event.color || 'linear-gradient(135deg, #60a5fa, #3b82f6)';
                            if (event.completed) {
                                eventDiv.style.textDecoration = 'line-through';
                                eventDiv.style.opacity = '0.7';
                            }
                            slotEl.appendChild(eventDiv);
                        });
                    }

                    hourEl.appendChild(timeEl);
                    hourEl.appendChild(slotEl);
                        this.elements.scheduleContent.appendChild(hourEl);
                    }
                },

                                 // --- UTILITY FUNCTIONS ---
                 getDayTimeIcon() {
                     const hour = new Date().getHours();
                     if (hour >= 6 && hour < 12) {
                         return 'üåÖ'; // Sunrise (6 AM - 12 PM)
                     } else if (hour >= 12 && hour < 18) {
                         return 'üåû'; // Sun (12 PM - 6 PM)  
                     } else if (hour >= 18 && hour < 21) {
                         return 'üåá'; // Sunset (6 PM - 9 PM)
                     } else {
                         return 'üåô'; // Moon (9 PM - 6 AM)
                     }
                 },

                 // --- NOTIFICATION SYSTEM ---
                 async requestNotificationPermission() {
                     if (!("Notification" in window)) {
                         console.log("This browser does not support notifications");
                         return false;
                     }

                     if (Notification.permission === "granted") {
                         this.state.notificationsEnabled = true;
                         this.updateNotificationIcon();
                         this.scheduleAllNotifications();
                         return true;
                     }

                     if (Notification.permission !== "denied") {
                         const permission = await Notification.requestPermission();
                         if (permission === "granted") {
                             this.state.notificationsEnabled = true;
                             this.updateNotificationIcon();
                             this.scheduleAllNotifications();
                             this.saveState();
                             return true;
                         }
                     }
                     return false;
                 },

                 updateNotificationIcon() {
                     const icon = document.getElementById('notification-icon');
                     if (icon) {
                         icon.textContent = this.state.notificationsEnabled ? 'üîî' : 'üîï';
                     }
                 },

                 showUserSetupModal() {
                     this.openModal(document.getElementById('user-setup-modal'));
                 },

                 showNotificationModal() {
                     this.openModal(document.getElementById('notification-modal'));
                 },

                 scheduleNotification(event, calendar, minutesBefore) {
                     if (!this.state.notificationsEnabled) return;

                     const eventTime = new Date(event.date);
                     const notifyTime = new Date(eventTime.getTime() - (minutesBefore * 60 * 1000));
                     const now = new Date();

                     if (notifyTime <= now) return; // Don't schedule past notifications

                     const timeoutId = setTimeout(() => {
                         this.sendNotification(event, calendar, minutesBefore);
                     }, notifyTime.getTime() - now.getTime());

                     // Store the timeout ID so we can cancel it later if needed
                     const notificationKey = `${event.id}-${minutesBefore}`;
                     this.state.scheduledNotifications.set(notificationKey, timeoutId);
                 },

                 sendNotification(event, calendar, minutesBefore) {
                     if (!this.state.notificationsEnabled || Notification.permission !== "granted") return;

                     const theme = this.config.colorSchemes[calendar.theme];
                     const timeText = minutesBefore === 0 ? "now" : `in ${minutesBefore} minutes`;
                     
                     const notification = new Notification(`${theme.icon} ${event.name}`, {
                         body: `Your event "${event.name}" is starting ${timeText}!`,
                         icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">' + theme.icon + '</text></svg>',
                         tag: event.id,
                         requireInteraction: false,
                         silent: false
                     });

                     // Auto-close notification after 8 seconds
                     setTimeout(() => notification.close(), 8000);

                     // Optional: Focus the calendar when notification is clicked
                     notification.onclick = () => {
                         window.focus();
                         notification.close();
                     };
                 },

                 scheduleAllNotifications() {
                     if (!this.state.notificationsEnabled) return;

                     // Clear existing notifications
                     this.state.scheduledNotifications.forEach(timeoutId => clearTimeout(timeoutId));
                     this.state.scheduledNotifications.clear();

                     // Schedule notifications for all upcoming events
                     this.state.calendars.forEach(calendar => {
                         if (calendar.events) {
                             Object.values(calendar.events).forEach(dayEvents => {
                                 dayEvents.forEach(event => {
                                     if (!event.completed) {
                                         this.state.notificationTimes.forEach(minutes => {
                                             this.scheduleNotification(event, calendar, minutes);
                                         });
                                     }
                                 });
                             });
                         }
                     });
                 },

                 // --- VOTING SYSTEM ---
                 createPoll(title, description, date, isEvent) {
                     const poll = {
                         id: `poll-${Date.now()}`,
                         title: title,
                         description: description,
                         date: date,
                         isEvent: isEvent,
                         creator: this.state.userKey || 'anonymous',
                         createdAt: Date.now(),
                         votes: {
                             yes: [],
                             no: []
                         }
                     };

                     this.state.polls.push(poll);
                     
                     // If it's an event, also add to calendar
                     if (isEvent && this.state.activeCalendarId) {
                         const eventDate = new Date(date);
                         this.addEvent(this.state.activeCalendarId, eventDate, title, 'event-color-1', null);
                     }
                     
                     this.renderPolls();
                     this.saveState();
                 },

                 voteOnPoll(pollId, vote) {
                     const poll = this.state.polls.find(p => p.id === pollId);
                     if (!poll) return;

                     const userId = this.state.userKey || 'anonymous';
                     
                     // Remove previous vote if exists
                     poll.votes.yes = poll.votes.yes.filter(id => id !== userId);
                     poll.votes.no = poll.votes.no.filter(id => id !== userId);
                     
                     // Add new vote
                     if (vote === 'yes') {
                         poll.votes.yes.push(userId);
                     } else if (vote === 'no') {
                         poll.votes.no.push(userId);
                     }
                     
                     this.renderPolls();
                     this.saveState();
                 },

                 renderPolls() {
                     const container = document.getElementById('polls-container');
                     if (!container) return;

                     if (this.state.polls.length === 0) {
                         container.innerHTML = `
                             <div class="text-center py-12">
                                 <div class="text-6xl mb-4">üó≥Ô∏è</div>
                                 <h3 class="text-xl font-medium mb-2">No polls yet!</h3>
                                 <p class="text-gray-600 mb-4">Create the first poll to get started</p>
                                 <button onclick="app.openCreatePollModal()" class="clean-btn">
                                     <i class="fas fa-plus mr-2"></i>Create First Poll
                                 </button>
                             </div>
                         `;
                         return;
                     }

                     container.innerHTML = '';
                     
                     // Sort polls by date (newest first)
                     const sortedPolls = [...this.state.polls].sort((a, b) => new Date(b.date) - new Date(a.date));
                     
                     sortedPolls.forEach(poll => {
                         const pollEl = document.createElement('div');
                         pollEl.className = 'poll-card';
                         
                         const userId = this.state.userKey || 'anonymous';
                         const userVote = poll.votes.yes.includes(userId) ? 'yes' : 
                                        poll.votes.no.includes(userId) ? 'no' : null;
                         
                         const dateStr = new Date(poll.date).toLocaleDateString('en-US', {
                             weekday: 'long',
                             month: 'long',
                             day: 'numeric',
                             hour: '2-digit',
                             minute: '2-digit'
                         });

                         pollEl.innerHTML = `
                             <div class="poll-header">
                                 <div>
                                     <div class="poll-title">${poll.title}</div>
                                     ${poll.description ? `<div class="poll-description">${poll.description}</div>` : ''}
                                     <div class="poll-date">üìÖ ${dateStr}</div>
                                 </div>
                                 ${poll.isEvent ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">üìÖ Event</span>' : ''}
                             </div>
                             
                             <div class="poll-actions">
                                 <button class="vote-btn yes ${userVote === 'yes' ? 'voted' : ''}" onclick="app.voteOnPoll('${poll.id}', 'yes')">
                                     üëç Yes (${poll.votes.yes.length})
                                 </button>
                                 <button class="vote-btn no ${userVote === 'no' ? 'voted' : ''}" onclick="app.voteOnPoll('${poll.id}','no')">
                                     üëé No (${poll.votes.no.length})
                                 </button>
                             </div>
                             
                             <div class="vote-counts">
                                 <div class="vote-count yes">
                                     <span>üëç</span>
                                     <span>${poll.votes.yes.length} votes</span>
                                 </div>
                                 <div class="vote-count no">
                                     <span>üëé</span>
                                     <span>${poll.votes.no.length} votes</span>
                                 </div>
                             </div>
                             
                             <div class="poll-creator">Created by: ${poll.creator === userId ? 'You' : poll.creator}</div>
                         `;
                         
                         container.appendChild(pollEl);
                     });
                                 },

                // --- CHORE MANAGEMENT ---
                addChore(title, description, difficulty) {
                    const newChore = {
                        id: `chore-${Date.now()}`,
                        title,
                        description: description || '',
                        difficulty,
                        status: 'unclaimed', // 'unclaimed', 'claimed', 'completed'
                        claimedBy: null,
                        claimedAt: null,
                        completedAt: null,
                        createdAt: Date.now()
                    };
                    
                    this.state.chores.push(newChore);
                    this.renderChores();
                    this.saveState();
                },

                claimChore(choreId) {
                    const chore = this.state.chores.find(c => c.id === choreId);
                    if (!chore || chore.status !== 'unclaimed') return;
                    
                    const userName = this.getUserKey() || 'Anonymous';
                    chore.status = 'claimed';
                    chore.claimedBy = userName;
                    chore.claimedAt = Date.now();
                    
                    this.renderChores();
                    this.saveState();
                },

                completeChore(choreId) {
                    const chore = this.state.chores.find(c => c.id === choreId);
                    if (!chore || chore.status !== 'claimed') return;
                    
                    chore.status = 'completed';
                    chore.completedAt = Date.now();
                    
                    this.renderChores();
                    this.saveState();
                },

                unclaimChore(choreId) {
                    const chore = this.state.chores.find(c => c.id === choreId);
                    if (!chore || chore.status !== 'claimed') return;
                    
                    chore.status = 'unclaimed';
                    chore.claimedBy = null;
                    chore.claimedAt = null;
                    
                    this.renderChores();
                    this.saveState();
                },

                renderChores() {
                    const unclaimedContainer = document.getElementById('unclaimed-chores');
                    const claimedContainer = document.getElementById('claimed-chores');
                    const completedContainer = document.getElementById('completed-chores');
                    
                    if (!unclaimedContainer || !claimedContainer || !completedContainer) return;
                    
                    // Filter chores by status
                    const unclaimed = this.state.chores.filter(c => c.status === 'unclaimed');
                    const claimed = this.state.chores.filter(c => c.status === 'claimed');
                    const completed = this.state.chores.filter(c => c.status === 'completed');
                    
                    // Render unclaimed chores
                    if (unclaimed.length === 0) {
                        unclaimedContainer.innerHTML = '<p class="text-gray-500 text-sm">No chores available</p>';
                    } else {
                        unclaimedContainer.innerHTML = unclaimed.map(chore => `
                            <div class="chore-item card-elevated p-4 fade-in">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-medium">${chore.title}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full ${chore.difficulty === 'easy' ? 'bg-green-100 text-green-700' : chore.difficulty === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${chore.difficulty}</span>
                                </div>
                                ${chore.description ? `<p class="text-sm text-gray-600 mb-2">${chore.description}</p>` : ''}
                                <button onclick="app.claimChore('${chore.id}')" class="clean-btn secondary text-xs w-full">
                                    üëã Claim This
                                </button>
                            </div>
                        `).join('');
                    }
                    
                    // Render claimed chores
                    if (claimed.length === 0) {
                        claimedContainer.innerHTML = '<p class="text-gray-500 text-sm">No claimed chores</p>';
                    } else {
                        claimedContainer.innerHTML = claimed.map(chore => `
                            <div class="chore-item card-elevated p-4 fade-in border-l-4 border-blue-400">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-medium">${chore.title}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full ${chore.difficulty === 'easy' ? 'bg-green-100 text-green-700' : chore.difficulty === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${chore.difficulty}</span>
                                </div>
                                ${chore.description ? `<p class="text-sm text-gray-600 mb-2">${chore.description}</p>` : ''}
                                <p class="text-xs text-blue-600 mb-2">Claimed by: ${chore.claimedBy}</p>
                                <div class="flex gap-2">
                                    <button onclick="app.completeChore('${chore.id}')" class="clean-btn text-xs flex-1">
                                        ‚úÖ Complete
                                    </button>
                                    <button onclick="app.unclaimChore('${chore.id}')" class="clean-btn secondary text-xs">
                                        ‚Ü©Ô∏è
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    // Render completed chores
                    if (completed.length === 0) {
                        completedContainer.innerHTML = '<p class="text-gray-500 text-sm">No completed chores</p>';
                    } else {
                        completedContainer.innerHTML = completed.map(chore => `
                            <div class="chore-item card-elevated p-4 fade-in border-l-4 border-green-400 opacity-75">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-medium line-through">${chore.title}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full ${chore.difficulty === 'easy' ? 'bg-green-100 text-green-700' : chore.difficulty === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${chore.difficulty}</span>
                                </div>
                                ${chore.description ? `<p class="text-sm text-gray-600 mb-2 line-through">${chore.description}</p>` : ''}
                                <p class="text-xs text-green-600">Completed by: ${chore.claimedBy}</p>
                                <p class="text-xs text-gray-500">${new Date(chore.completedAt).toLocaleDateString()}</p>
                            </div>
                        `).join('');
                    }
                },

                switchView(view) {
                     this.state.currentView = view;
                     
                     // Update view toggle buttons
                     document.getElementById('view-toggle-btn').classList.toggle('active', view === 'calendar');
                     document.getElementById('voting-view-btn').classList.toggle('active', view === 'voting');
                     document.getElementById('chores-view-btn').classList.toggle('active', view === 'chores');
                     
                     // Show/hide views
                     document.getElementById('calendar-view').classList.toggle('hidden', view !== 'calendar');
                     document.getElementById('voting-view').classList.toggle('hidden', view !== 'voting');
                     document.getElementById('chores-view').classList.toggle('hidden', view !== 'chores');
                     
                     // Update view icon
                     let icon = 'üìÖ';
                     if (view === 'voting') icon = 'üó≥Ô∏è';
                     if (view === 'chores') icon = 'üßπ';
                     document.getElementById('view-icon').textContent = icon;
                     
                     if (view === 'voting') {
                         this.renderPolls();
                     } else if (view === 'chores') {
                         this.renderChores();
                     } else {
                         this.renderCalendar();
                     }
                 },

                                 openCreatePollModal() {
                    this.openModal(document.getElementById('create-poll-modal'));
                    // Set default date to tomorrow
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(18, 0, 0, 0);
                    document.getElementById('poll-date').value = tomorrow.toISOString().slice(0, 16);
                },

                openAddChoreModal() {
                    this.openModal(document.getElementById('add-chore-modal'));
                },

                 // --- CALENDAR VISIBILITY CONTROLS ---
                 toggleCalendarVisibility(calendarId) {
                     if (this.state.visibleCalendars.has(calendarId)) {
                         this.state.visibleCalendars.delete(calendarId);
                     } else {
                         this.state.visibleCalendars.add(calendarId);
                     }
                     this.renderCalendar();
                     this.saveState();
                 },

                // --- EVENT HANDLERS & LOGIC ---
                 changeMonth(offset) {
                    this.state.currentDate.setMonth(this.state.currentDate.getMonth() + offset);
                    this.renderCalendar();
                    this.saveState();
                },

                switchCalendar(calendarId) {
                    this.state.activeCalendarId = calendarId;
                    this.renderTabs();
                    this.renderCalendar();
                    this.saveState();
                },
                
                addCalendar(name, theme) {
                const newCalendar = {
                    id: `cal-${Date.now()}`,
                    name: name,
                    theme: theme,
                    events: {}
                };
                    this.state.calendars.push(newCalendar);
                    this.switchCalendar(newCalendar.id);
                },

                                 addEvent(calendarId, date, name, color, linkedCalendarId) {
                     const calendar = this.state.calendars.find(c => c.id === calendarId);
                if (!calendar) return;

                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();
                const dateKey = `${year}-${month}-${day}`;

                if (!calendar.events[dateKey]) {
                    calendar.events[dateKey] = [];
                }

                const newEvent = {
                    id: `evt-${Date.now()}`,
                    name: name,
                    color: color,
                    completed: false,
                    date: date.toISOString()
                };
                calendar.events[dateKey].push(newEvent);
                
                if (linkedCalendarId) {
                         const linkedCalendar = this.state.calendars.find(c => c.id === linkedCalendarId);
                    if (linkedCalendar) {
                        if (!linkedCalendar.events[dateKey]) {
                            linkedCalendar.events[dateKey] = [];
                        }
                        linkedCalendar.events[dateKey].push({...newEvent, id: `evt-${Date.now()}-linked`});
                    }
                }

                     // Schedule notifications for the new event
                     if (this.state.notificationsEnabled) {
                         this.state.notificationTimes.forEach(minutes => {
                             this.scheduleNotification(newEvent, calendar, minutes);
                         });
                     }

                     this.renderCalendar();
                     if (this.elements.dailySchedulePanel.classList.contains('open')) {
                         this.renderDailySchedule(new Date(date.getFullYear(), date.getMonth(), date.getDate()));
                     }
                     this.saveState();
                 },
                
                toggleEventCompletion(eventId) {
                    const activeCalendar = this.state.calendars.find(c => c.id === this.state.activeCalendarId);
                if (activeCalendar && activeCalendar.events) {
                    for (const dateKey in activeCalendar.events) {
                        const event = activeCalendar.events[dateKey].find(e => e.id === eventId);
                        if (event) {
                            event.completed = !event.completed;
                            break;
                        }
                    }
                }
                    this.renderCalendar();
                    this.saveState();
                },

            // --- MODAL & SIDEBAR CONTROLS ---
                selectedDateForEvent: null,
                selectedColorScheme: 'theme-warm-neutrals',
                selectedEventColor: 'event-color-1',

                openModal(modal) {
                    this.elements.modalBackdrop.classList.remove('hidden');
                modal.classList.remove('hidden');
                },

                closeModal(modal) {
                    this.elements.modalBackdrop.classList.add('hidden');
                modal.classList.add('hidden');
                },

                                 showWelcomeModal() {
                     this.openModal(this.elements.addCalendarModal);
                     // Update the modal title for first-time users
                     const modalTitle = document.querySelector('#add-calendar-modal h3');
                     if (modalTitle && this.state.calendars.length === 0) {
                         modalTitle.textContent = 'Welcome! Create Your First Calendar üåü';
                     }
                 },

                 openAddCalendarModal() {
                     this.openModal(this.elements.addCalendarModal);
                     // Reset title for regular add calendar
                     const modalTitle = document.querySelector('#add-calendar-modal h3');
                     if (modalTitle) {
                         modalTitle.textContent = 'Create New Calendar';
                     }
                 },

                openAddEventModal(date) {
                    this.selectedDateForEvent = date;
                document.getElementById('event-modal-date').textContent = date.toLocaleDateString();
                    
                    // Clear the event name input
                    document.getElementById('event-name-input').value = '';
                    
                    // Reset event color selection
                    this.selectedEventColor = 'event-color-1';
                    document.querySelectorAll('#event-colors div').forEach(div => {
                        div.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                    });
                    document.querySelector('#event-colors div[data-color="event-color-1"]').classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                
                const select = document.getElementById('link-calendar-select');
                select.innerHTML = '<option value="">None</option>';
                    this.state.calendars
                        .filter(c => c.id !== this.state.activeCalendarId)
                    .forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        select.appendChild(option);
                    });

                    this.openModal(this.elements.addEventModal);
                },

                openDailySchedule(date) {
                    this.renderDailySchedule(date);
                    this.elements.dailySchedulePanel.classList.add('open');
                    this.elements.modalBackdrop.classList.remove('hidden');
                    this.elements.dailySchedulePanel.dataset.date = date.toISOString();
                },

                closeDailySchedule() {
                    this.elements.dailySchedulePanel.classList.remove('open');
                    this.elements.modalBackdrop.classList.add('hidden');
                },
                
                // --- INITIALIZATION ---
                async init() {
                    this.elements = {
                        calendarGrid: document.getElementById('calendar-grid'),
                        monthYearHeader: document.getElementById('month-year'),
                        prevMonthBtn: document.getElementById('prev-month'),
                        nextMonthBtn: document.getElementById('next-month'),
                        tabsContainer: document.getElementById('tabs-container'),
                        modalBackdrop: document.getElementById('modal-backdrop'),
                        addCalendarModal: document.getElementById('add-calendar-modal'),
                        addEventModal: document.getElementById('add-event-modal'),
                        dailySchedulePanel: document.getElementById('daily-schedule'),
                        scheduleDateHeader: document.getElementById('schedule-date'),
                        scheduleContent: document.getElementById('schedule-content'),
                        addCalendarBtn: document.getElementById('add-calendar-btn')
                    };
                    
                    this.addEventListeners();
                    this.switchView('calendar');
                    
                    const userKey = this.getUserKey();
                    
                    if (!userKey) {
                        this.showUserSetupModal();
                    } else {
                        await this.loadState();
                        
                        const activeCalendar = this.state.calendars.find(c => c.id === this.state.activeCalendarId);
                        if (activeCalendar) {
                            this.applyFullPageTheme(this.config.colorSchemes[activeCalendar.theme]);
                        }
                        
                        this.getLocationAndFetchWeather();
                        this.renderTabs();
                        this.renderCalendar();
                        
                        if (this.state.notificationsEnabled) {
                            this.scheduleAllNotifications();
                        }
                    }
                     
                     // Auto-sync from cloud every 2 minutes
                     setInterval(async () => {
                         if (this.getUserKey()) {
                            await this.loadState();
                            this.renderTabs();
                            this.renderCalendar();
                         }
                     }, 120000);
                },
                
                addEventListeners() {
                                         this.elements.prevMonthBtn.addEventListener('click', () => this.changeMonth(-1));
                     this.elements.nextMonthBtn.addEventListener('click', () => this.changeMonth(1));
                     this.elements.addCalendarBtn.addEventListener('click', () => this.openAddCalendarModal());
                     
                     // View toggle
                     document.getElementById('view-toggle-btn').addEventListener('click', () => this.switchView('calendar'));
                     document.getElementById('voting-view-btn').addEventListener('click', () => this.switchView('voting'));
                     document.getElementById('chores-view-btn').addEventListener('click', () => this.switchView('chores'));
                     
                     // Create poll button
                     document.getElementById('create-poll-btn').addEventListener('click', () => this.openCreatePollModal());
                     
                     // Create chore button
                     document.getElementById('add-chore-btn').addEventListener('click', () => this.openAddChoreModal());
                     
                     // Poll modal handlers
                     document.getElementById('cancel-create-poll').addEventListener('click', () => this.closeModal(document.getElementById('create-poll-modal')));
                     document.getElementById('confirm-create-poll').addEventListener('click', () => {
                         const title = document.getElementById('poll-title').value.trim();
                         const description = document.getElementById('poll-description').value.trim();
                         const date = document.getElementById('poll-date').value;
                         const isEvent = document.getElementById('poll-is-event').checked;
                         
                         if (title && date) {
                             this.createPoll(title, description, date, isEvent);
                             this.closeModal(document.getElementById('create-poll-modal'));
                             
                             // Clear form
                             document.getElementById('poll-title').value = '';
                             document.getElementById('poll-description').value = '';
                             document.getElementById('poll-is-event').checked = false;
                         }
                                          });
                     
                     // Chore modal handlers
                     document.getElementById('cancel-add-chore').addEventListener('click', () => this.closeModal(document.getElementById('add-chore-modal')));
                     document.getElementById('confirm-add-chore').addEventListener('click', () => {
                         const title = document.getElementById('chore-title').value.trim();
                         const description = document.getElementById('chore-description').value.trim();
                         const difficulty = document.getElementById('chore-difficulty').value;
                         
                         if (title) {
                             this.addChore(title, description, difficulty);
                             this.closeModal(document.getElementById('add-chore-modal'));
                             // Clear form
                             document.getElementById('chore-title').value = '';
                             document.getElementById('chore-description').value = '';
                             document.getElementById('chore-difficulty').value = 'easy';
                         }
                     });
                     
                                          // Notification settings
                      const notificationBtn = document.getElementById('notification-settings-btn');
                      if (notificationBtn) {
                          notificationBtn.addEventListener('click', () => {
                              if (this.state.notificationsEnabled) {
                                  this.state.notificationsEnabled = false;
                                  this.state.scheduledNotifications.forEach(timeoutId => clearTimeout(timeoutId));
                                  this.state.scheduledNotifications.clear();
                                  this.updateNotificationIcon();
                                  this.saveState();
                              } else {
                                  this.showNotificationModal();
                              }
                          });
                      }

                      // Session button
                      const sessionBtn = document.getElementById('session-btn');
                      if (sessionBtn) {
                          sessionBtn.addEventListener('click', () => {
                              this.openSessionInfoModal();
                          });
                      }

                      // Session info modal handlers
                      const switchSessionBtn = document.getElementById('switch-session-btn');
                      const closeSessionModal = document.getElementById('close-session-modal');

                      if (switchSessionBtn) {
                          switchSessionBtn.addEventListener('click', () => {
                              this.switchToNewSession();
                          });
                      }

                      if (closeSessionModal) {
                          closeSessionModal.addEventListener('click', () => {
                              this.closeModal(document.getElementById('session-info-modal'));
                          });
                      }

                     // User setup modal handlers
                     const setupSyncBtn = document.getElementById('setup-sync');
                     const userSyncCodeInput = document.getElementById('user-sync-code');

                     if (setupSyncBtn) {
                         setupSyncBtn.addEventListener('click', () => {
                             const syncCode = userSyncCodeInput.value.trim();
                             if (syncCode) {
                                 const userKey = 'user_' + syncCode.toLowerCase().replace(/[^a-z0-9]/g, '');
                                 this.setUserKey(userKey);
                                 this.closeModal(document.getElementById('user-setup-modal'));
                                 
                                 // After setting the key, initialize the main app view
                                 this.init(); 
                             }
                         });
                     }

                     const enableBtn = document.getElementById('enable-notifications');
                     const denyBtn = document.getElementById('deny-notifications');
                     
                     if (enableBtn) {
                         enableBtn.addEventListener('click', async () => {
                             const granted = await this.requestNotificationPermission();
                             this.closeModal(document.getElementById('notification-modal'));
                             if (granted) {
                                 setTimeout(() => {
                                     const activeCalendar = this.state.calendars.find(c => c.id === this.state.activeCalendarId);
                                     if (activeCalendar) {
                                         const theme = this.config.colorSchemes[activeCalendar.theme];
                                         new Notification(`${theme.icon} Notifications Enabled!`, {
                                             body: "You'll now get cute reminders for your upcoming events!",
                                             icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">' + theme.icon + '</text></svg>'
                                         });
                                     }
                                 }, 500);
                             }
                         });
                     }

                     if (denyBtn) {
                         denyBtn.addEventListener('click', () => {
                             this.closeModal(document.getElementById('notification-modal'));
                         });
                     }

                    document.getElementById('cancel-add-calendar').addEventListener('click', () => this.closeModal(this.elements.addCalendarModal));
                    document.getElementById('cancel-add-event').addEventListener('click', () => this.closeModal(this.elements.addEventModal));
                    this.elements.modalBackdrop.addEventListener('click', () => {
                        this.closeModal(this.elements.addCalendarModal);
                        this.closeModal(this.elements.addEventModal);
                        this.closeDailySchedule();
                    });
                    document.getElementById('close-schedule').addEventListener('click', () => this.closeDailySchedule());

            document.querySelectorAll('.color-scheme-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.color-scheme-option div').forEach(div => div.classList.remove('ring-4', 'ring-offset-2', 'ring-blue-500'));
                    el.querySelector('div').classList.add('ring-4', 'ring-offset-2', 'ring-blue-500');
                            this.selectedColorScheme = el.dataset.theme;
                });
            });

            document.getElementById('confirm-add-calendar').addEventListener('click', () => {
                const name = document.getElementById('new-calendar-name').value;
                        if (name && this.selectedColorScheme) {
                            this.addCalendar(name, this.selectedColorScheme);
                            this.closeModal(this.elements.addCalendarModal);
                    document.getElementById('new-calendar-name').value = '';
                }
            });

            document.getElementById('event-colors').addEventListener('click', (e) => {
                if (e.target.dataset.color) {
                            this.selectedEventColor = e.target.dataset.color;
                    document.querySelectorAll('#event-colors div').forEach(div => div.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
                    e.target.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                }
            });

            document.getElementById('save-event').addEventListener('click', () => {
                        const name = document.getElementById('event-name-input').value.trim();
                const linkedCalendarId = document.getElementById('link-calendar-select').value;
                        
                        if (!name) {
                            alert('Please enter an event name');
                            return;
                        }
                        
                        if (!this.selectedDateForEvent) {
                            alert('No date selected');
                            return;
                        }
                        
                        if (!this.state.activeCalendarId) {
                            alert('Please create a calendar first');
                            return;
                        }
                        
                        const eventDate = new Date(this.selectedDateForEvent);
                    eventDate.setHours(12, 0, 0, 0);
                        this.addEvent(this.state.activeCalendarId, eventDate, name, this.selectedEventColor, linkedCalendarId);
                        this.closeModal(this.elements.addEventModal);
                    document.getElementById('event-name-input').value = '';
            });
            
            document.getElementById('schedule-add-event-btn').addEventListener('click', () => {
                        const name = document.getElementById('schedule-event-input').value.trim();
                const time = document.getElementById('schedule-event-time').value;
                        const baseDate = new Date(this.elements.dailySchedulePanel.dataset.date);
                        
                        if (!name) {
                            alert('Please enter an event name');
                            return;
                        }
                        
                        if (!time) {
                            alert('Please select a time');
                            return;
                        }
                        
                        if (!this.state.activeCalendarId) {
                            alert('Please create a calendar first');
                            return;
                        }
                        
                    const [hours, minutes] = time.split(':');
                    baseDate.setHours(parseInt(hours), parseInt(minutes));
                        this.addEvent(this.state.activeCalendarId, baseDate, name, 'event-color-1', null);
                        this.renderDailySchedule(new Date(this.elements.dailySchedulePanel.dataset.date));
                    document.getElementById('schedule-event-input').value = '';
                    document.getElementById('schedule-event-time').value = '';
                    });
                }
            };
            
            // Make app globally available for toggle callbacks
            window.app = app;
            app.init();
        });
    </script>
</body>
</html>